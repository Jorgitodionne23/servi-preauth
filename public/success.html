<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago confirmado - SERVI</title>

  <!-- Stripe.js so we can read the PI description for adjustment reason -->
  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 85vh;
      text-align: center;
      padding: 20px;
      line-height: 1.6;
    }

    .logo { width: 150px; margin-bottom: 30px; }

    .container {
      background-color: #111;
      padding: 30px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 400px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 17px;
    }

    .checkmark-img { width: 48px; height: 48px; object-fit: contain; }

    h1 { font-size: 19px; font-weight: 600; margin: 0; line-height: 27px; letter-spacing: .5px; }

    .order-number { font-size: 14px; color: #ccc; }

    .summary-box {
      background:#1a1a1a;
      width:100%;
      padding:16px;
      border-radius:10px;
      text-align:left;
    }
    .row { display:flex; justify-content:space-between; align-items:flex-start; margin:6px 0; gap:12px; }
    .label { color:#9ca3af; font-size:14px; }
    .value { color:#fff; font-size:13px; text-align:right; word-break:break-word; }
    .row.total { margin-top: 0; font-weight: 600; }
    .row.total .value { font-size: 15px; }
    .note { margin: 6px 0 10px; color: #9ca3af; font-size: 12px; }

    a.button {
      display: inline-block;
      background-color: #fff;
      color: #000;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      font-size: 15px;
    }

    .footer { font-size: 11.5px; color: #aaa; margin-top: 30px; text-align: center; }
    .footer a { color: #fff; text-decoration: none; }

    .footer-stripe { margin-top: 30px; text-align: center; }
    .footer-stripe img { height: 32px; max-width: 100%; object-fit: contain; }
  </style>
</head>
<body>
  <!-- Logo above the confirmation box -->
  <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

  <div class="container">
    <!-- Checkmark image -->
    <img src="checkmark-green.png" alt="Éxito" class="checkmark-img" />

    <!-- Confirmation message -->
    <h1 id="title" style="margin-bottom: 0.5em;">¡Tu servicio ha sido reservado!</h1>
    <p id="subtitle" style="margin-top: -1em; color: #ccc; font-size: 15px;">
      Te mandaremos un mensaje recordatorio antes de tu servicio.
    </p>

    <!-- Real order code from server -->
    <div class="order-number">
      Número de orden: <span id="order-id">cargando...</span>
    </div>

    <!-- Summary (amount, status, and adjustment reason when applicable) -->
    <div class="summary-box">
      <div class="row total">
        <div class="label">Total</div>
        <div class="value" id="amount">—</div>
      </div>
      <div class="note" id="vat-note" style="display:none;">*IVA incluido</div>
      <div class="row" id="service-price-row" style="display:none;">
        <div class="label">Precio del servicio</div>
        <div class="value" id="service-price">—</div>
      </div>
      <div class="row" id="processing-row" style="display:none;">
        <div class="label">Comisión por procesamiento</div>
        <div class="value" id="processing-fee">—</div>
      </div>
      <div class="row">
        <div class="label">Dirección</div>
        <div class="value" id="address">—</div>
      </div>
      <div class="row" id="reason-row" style="display:none">
        <div class="label">Motivo del ajuste</div>
        <div class="value" id="reason">—</div>
      </div>
    </div>

    <!-- WhatsApp CTA -->
    <a href="https://wa.me/525525112588" class="button">
      Ver o modificar tu solicitud
    </a>
  </div>

  <!-- footer -->
  <div class="footer">
    ¿Necesitas ayuda?
    <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank" rel="noopener">Centro de ayuda</a>
  </div>

  <div class="footer-stripe">
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    let orderId = qs.get('orderId') || localStorage.getItem('orderId');

    const targetOrderId = document.getElementById('order-id');
    const amountEl = document.getElementById('amount');
    const addressEl = document.getElementById('address');
    const statusEl = document.getElementById('status');
    const reasonRow = document.getElementById('reason-row');
    const reasonEl = document.getElementById('reason');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const servicePriceRow = document.getElementById('service-price-row');
    const servicePriceEl = document.getElementById('service-price');
    const processingRow = document.getElementById('processing-row');
    const processingEl = document.getElementById('processing-fee');
    const vatNoteEl = document.getElementById('vat-note');
    const summaryBox = document.querySelector('.summary-box');

    const PREVIEW_KEY = 'serviSuccessPreview';

    function fmtAmount(cents) {
      try { return (Number(cents || 0) / 100).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }
      catch { return '—'; }
    }

    function friendlyCode(order) {
      return (order.public_code
        ? String(order.public_code)
        : String(order.id).replace(/-/g, '').slice(-8)
      ).toUpperCase();
    }

    function extractReason(desc) {
      const m = (desc || '').match(/SERVI ajuste:\s*(.*)$/i);
      return m && m[1] ? m[1] : null;
    }

    function toNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : 0;
    }

    function buildPreviewFromOrder(order) {
      return {
        orderId: order.id || null,
        publicCode: order.public_code || null,
        totalCents: toNumber(order.amount ?? order.pricing?.total_amount),
        providerCents: toNumber(order.provider_amount ?? order.pricing?.provider_amount),
        bookingCents: toNumber(order.booking_fee_amount ?? order.pricing?.booking_fee_amount),
        processingCents: toNumber(order.processing_fee_amount ?? order.pricing?.processing_fee_amount),
        vatCents: toNumber(order.vat_amount ?? order.pricing?.vat_amount),
        kind: String(order.kind || ''),
        reason: String(order.adjustment_reason || ''),
        serviceAddress: order.service_address || ''
      };
    }

    function storePreview(snapshot) {
      try {
        sessionStorage.setItem(PREVIEW_KEY, JSON.stringify(snapshot));
      } catch (_) {}
    }

    function getPreview(orderId) {
      try {
        const raw = sessionStorage.getItem(PREVIEW_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (parsed && parsed.orderId && parsed.orderId === orderId) return parsed;
      } catch (_) {}
      return null;
    }

    function renderOrder(order, { totalsOverride = null, reasonOverride = null, skipStripeReason = false } = {}) {
      try {
        targetOrderId.textContent = friendlyCode(order);
      } catch (_) {
        targetOrderId.textContent = 'no disponible';
      }

      const totals = totalsOverride || {};
      const totalCents = toNumber(order.amount ?? totals.totalCents ?? order.pricing?.total_amount);
      const providerCents = toNumber(order.provider_amount ?? totals.providerCents ?? order.pricing?.provider_amount);
      const bookingCents = toNumber(order.booking_fee_amount ?? totals.bookingCents ?? order.pricing?.booking_fee_amount);
      const processingCents = toNumber(order.processing_fee_amount ?? totals.processingCents ?? order.pricing?.processing_fee_amount);
      const vatCents = toNumber(order.vat_amount ?? totals.vatCents ?? order.pricing?.vat_amount);
      const serviceCents = providerCents + bookingCents + vatCents;

      amountEl.textContent = fmtAmount(totalCents);
      if (serviceCents > 0) {
        servicePriceEl.textContent = fmtAmount(serviceCents);
        servicePriceRow.style.display = 'flex';
      } else {
        servicePriceRow.style.display = 'none';
      }

      if (processingCents > 0) {
        processingEl.textContent = fmtAmount(processingCents);
        processingRow.style.display = 'flex';
      } else {
        processingRow.style.display = 'none';
      }

      vatNoteEl.style.display = vatCents > 0 ? 'block' : 'none';
      if (summaryBox && vatNoteEl && servicePriceRow) {
        summaryBox.insertBefore(vatNoteEl, servicePriceRow);
      }

      addressEl.textContent = order.service_address || totals.serviceAddress || '—';
      statusEl.textContent = order.status || '—';

      const isAdjustment = String(order.kind || totals.kind || '').toLowerCase() === 'adjustment';
      if (isAdjustment) {
        titleEl.textContent = '¡Ajuste confirmado!';
        subtitleEl.textContent = 'Gracias, hemos recibido tu pago adicional.';
      } else {
        titleEl.textContent = '¡Tu servicio ha sido reservado!';
        subtitleEl.textContent = 'Te mandaremos un mensaje recordatorio antes de tu servicio.';
      }

      const fallbackReason = reasonOverride || totals.reason || '';
      let displayReason = String(order.adjustment_reason || '').trim() || fallbackReason;
      if (isAdjustment && displayReason) {
        reasonEl.textContent = displayReason;
        reasonRow.style.display = 'flex';
      } else {
        reasonRow.style.display = 'none';
      }

      // If adjustment and no reason yet, try Stripe metadata unless skipped
      if (isAdjustment && !displayReason && !skipStripeReason && order.client_secret) {
        fetch('/config/stripe')
          .then(r => r.json())
          .then(cfg => {
            if (!cfg || !cfg.pk) return null;
            const stripe = Stripe(cfg.pk);
            return stripe.retrievePaymentIntent(order.client_secret);
          })
          .then(result => {
            const reason = extractReason(result?.paymentIntent?.description);
            if (reason) {
              reasonEl.textContent = reason;
              reasonRow.style.display = 'flex';
            }
          })
          .catch(() => {});
      }
    }

    (async () => {
      if (!orderId) {
        targetOrderId.textContent = 'no disponible';
        alert('Link inválido o incompleto. Por favor contacta a soporte.');
        return;
      }

      localStorage.setItem('orderId', String(orderId));
      const previewSnapshot = getPreview(orderId);

      try {
        const res = await fetch(`/order/${encodeURIComponent(orderId)}`);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const order = await res.json();

        storePreview(buildPreviewFromOrder(order));
        renderOrder(order, { reasonOverride: previewSnapshot?.reason });
      } catch (err) {
        if (previewSnapshot) {
          const pseudoOrder = {
            id: previewSnapshot.orderId,
            public_code: previewSnapshot.publicCode,
            amount: previewSnapshot.totalCents,
            provider_amount: previewSnapshot.providerCents,
            booking_fee_amount: previewSnapshot.bookingCents,
            processing_fee_amount: previewSnapshot.processingCents,
            vat_amount: previewSnapshot.vatCents,
            kind: previewSnapshot.kind,
            adjustment_reason: previewSnapshot.reason,
            service_address: previewSnapshot.serviceAddress,
            status: 'Confirmed'
          };
          renderOrder(pseudoOrder, {
            totalsOverride: previewSnapshot,
            reasonOverride: previewSnapshot.reason,
            skipStripeReason: true
          });
        } else {
          targetOrderId.textContent = 'no disponible';
          amountEl.textContent = '—';
          statusEl.textContent = '—';
        }
      }
    })();
  </script>
</body>
</html>
