<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
      * { box-sizing: border-box; }

      body {
        background-color: #000;
        color: #fff;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        line-height: 1.6;
      }

      .page {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .logo {
        max-width: 150px;
        margin-bottom: 20px;
      }

      .container {
        max-width: 400px;
        width: 100%;
        background: #111;
        padding: 36px 24px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      h2 {
        text-align: center;
        margin: 0;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: .2px;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: -15px;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        padding-top: 5px;
        margin-right: 30px;
      }

      #card-element {
        background-color: #222;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #444;
      }

      button {
        background-color: #fff;
        color: #000;
        border: none;
        padding: 11px;
        border-radius: 6px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: -5px;
      }

      #terms-checkbox {
      margin-left: 10px;
      }

      .terms-checkbox-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-wrap: nowrap;
      }

      .terms-label {
      font-size: 12px;
      color: #ccc;
      line-height: 1.4;
      flex: 1;
      word-break: break-word;
      }

      .terms-checkbox-wrapper input[type="checkbox"] {
        transform: scale(0.9);
        margin-top: -13px;
      }

      .terms-label a {
        color: rgb(255, 255, 255);
        text-decoration: underline;
      }

      .support {
        font-size: 12px;
        color: #ccc;
        text-align: center;
        margin-top: 16px;
      }

      .support a {
        color: rgb(255, 255, 255);
        text-decoration: none;
      }

      .footer {
        margin-top: 24px;
        text-align: center;
        color: #aaa;
        padding: 24px ;
      }

      .footer img {
        height: 32px;
        max-width: 100%;
        object-fit: contain;
      }
      .icon-input {
      position: relative;
      }

    .input-text {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px 12px 12px 43px; /* space for icon */
      color: #9ca3af;
      font-size: 16px;
      width: 100%;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

    .input-icon {
      position: absolute;
      top: 50%;
      left: 14px;
      bottom: 9px;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 14.1px;
      opacity: 0.17;
      pointer-events: none;
      }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
      }

    #service-summary {
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      }


    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
      }

    #spinner {
    display: none;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    color: #fff;
  }

  .spinner-circle {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  </style>

</head>
<body>
  <div class="page">
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Confirmar m√©todo de pago</h2>
      
      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando‚Ä¶</p>
      </div>


      <div id="express-pay-container" style="display:none;">
        <div id="express-pay-button"></div>
      </div>

      <form id="payment-form">
        <div class="form-row">
          <div id="card-element"></div>
        </div>
        <div class="form-row icon-input">
            <input 
                type="text" 
                id="cardholder-name" 
                name="cardholder-name" 
                placeholder="Nombre del titular"
                class="input-text"
                required
            />
            <span class="input-icon">üë§</span>
        </div>



        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox" class="terms-label">
              Al realizar tu pedido, aceptas nuestros
              <a href="https://serviservices.my.canva.site/helpcenter/#t√©rminos-y-condiciones" target="_blank">T√©rminos y Condiciones</a>
              y nuestro
              <a href="https://serviservices.my.canva.site/helpcenter/#aviso-de-privacidad" target="_blank">Aviso de Privacidad</a>.
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="consent-checkbox" />
            <label for="consent-checkbox" class="terms-label">
              Autorizo a SERVI a <strong>guardar esta tarjeta</strong> y realizar
              <strong>cargos adicionales</strong> relacionados con mi servicio
              (horas extra, piezas adicionales o correcciones), previa confirmaci√≥n por WhatsApp.
              <a href="#" id="consent-more">Ver detalles</a>
              <span id="consent-details" style="display:none"><br>
                ‚Ä¢ Datos guardados de forma segura en Stripe.<br>
                ‚Ä¢ Solo se aplicar√°n cargos cuando yo los apruebe por mensaje.<br>
                ‚Ä¢ Si mi banco exige verificaci√≥n, se me pedir√° confirmarlo (3-D Secure).<br>
                ‚Ä¢ Puedo solicitar la eliminaci√≥n de mi m√©todo de pago en cualquier momento.
              </span>
            </label>
          </div>
        </div>


        <button id="submit">Reservar servicio</button>
        
        <div id="spinner" style="display: none;">
          <div class="spinner-circle"></div>
        </div>
      </form>
    </div>

    <div class="support">
      ¬øNecesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    // Initialize Stripe from server config and mount the Card Element.
    // Expose stripe/elements/card on window so other code can use them.
    const stripeReady = (async () => {
      const resp = await fetch('/config/stripe');
      const { pk } = await resp.json();
      if (!pk) throw new Error('Missing STRIPE_PUBLISHABLE_KEY on server');

      const stripe = Stripe(pk);
      const elements = stripe.elements({ locale: 'es' });
      const card = elements.create("card", {
        style: {
          base: {
            fontFamily: '"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            fontSize: '16px',
            color: '#ffffff',
            '::placeholder': { color: '#9ca3af' }
          },
          invalid: { color: '#ef4444' }
        },
        hidePostalCode: true
      });
      card.mount("#card-element");

      // make globally accessible for later code
      window.stripe = stripe;
      window.elements = elements;
      window.card = card;
    })();


    // üÜï Fetch once, cache, and use everywhere
    let cachedOrder = null;
    async function getOrder() {
      if (cachedOrder) return cachedOrder;

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");
      if (!orderId) return null;

      const response = await fetch(`/order/${orderId}`);
      if (!response.ok) return null;

      cachedOrder = await response.json();
      return cachedOrder;
    }

    // init: fill summary + build Apple/Google Pay with real amount
    (async () => {
      await stripeReady;
      const order = await getOrder();
      if (!order) return;

      // Build one natural sentence, Uber-style
      const servicio = (order.service_description || "servicio").trim();
      const fechaTexto = formatFechaEs(order.service_date);
      const monto = (Number(order.amount || 0) / 100);
      const montoTexto = monto.toLocaleString("es-MX", { style: "currency", currency: "MXN" });

      // If the date coming from Sheets already includes a time window, we use it as-is.
      // Example Sheets value: "Lunes, 11 de Agosto entre 9:00 AM - 10:00"
      const resumen = `Reserva de ${servicio} el ${fechaTexto}, por ${montoTexto}.`;

      document.getElementById("service-summary").textContent = resumen;

      function formatFechaEs(value) {
        if (!value) return "‚Äî";

        // If it's ISO-like (YYYY-MM-DD or YYYY-MM-DDTHH:mm), pretty-format in Spanish
        if (/^\d{4}-\d{2}-\d{2}/.test(String(value))) {
          const d = new Date(value);
          if (!isNaN(d)) {
            // lunes ‚Üí Lunes, agosto ‚Üí agosto (keep month lowercase per Spanish style)
            const s = d.toLocaleDateString("es-MX", {
              weekday: "long", day: "2-digit", month: "long", year: "numeric"
            });
            // Capitalize first letter of weekday
            return s.charAt(0).toUpperCase() + s.slice(1);
          }
        }

        // Otherwise assume it already contains the full phrase/time window from Sheets
        return String(value);
      }



      // Create paymentRequest using the actual amount
      window.paymentRequest = stripe.paymentRequest({
        country: "MX",
        currency: "mxn",
        total: { label: "Servicio SERVI", amount: order.amount },
        requestPayerName: true,
        requestPayerEmail: true,
      });

      const prButton = elements.create("paymentRequestButton", {
        paymentRequest: window.paymentRequest,
        style: {
          paymentRequestButton: { type: "default", theme: "dark", height: "40px" }
        }
      });

      const can = await window.paymentRequest.canMakePayment();
      if (can) {
        document.getElementById("express-pay-container").style.display = "block";
        prButton.mount("#express-pay-button");

        // Attach the handler now that the button & paymentRequest exist
        window.paymentRequest.on("paymentmethod", async (ev) => {
          const order = await getOrder();
          if (!order) {
            ev.complete("fail");
            alert("Orden no encontrada. Contacta a soporte.");
            return;
          }

          const orderId = order.id;
          const clientSecret = order.client_secret;

          // 1) Try to confirm with the wallet PM, but don't trigger 3DS yet
          const first = await (window.stripe ?? stripe).confirmCardPayment(
            clientSecret,
            { payment_method: ev.paymentMethod.id },
            { handleActions: false }
          );

          if (first.error) {
            ev.complete("fail");
            alert(first.error.message);
            return;
          }

          // 2) Tell the wallet we accepted the PM
          ev.complete("success");

          // 3) If 3DS is required, handle it now
          const second = await (window.stripe ?? stripe).confirmCardPayment(clientSecret);
          if (second.error) {
            alert("Error al confirmar: " + second.error.message);
            return;
          }

          // 4) Success ‚Üí redirect
          localStorage.setItem('orderId', String(orderId));
          window.location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        });
      }

    })();


     

    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const spinner = document.getElementById("spinner");

    // Toggle consent details UI
    document.getElementById('consent-more').addEventListener('click', (e)=>{
      e.preventDefault();
      const box = document.getElementById('consent-details');
      box.style.display = box.style.display === 'none' ? 'inline' : 'none';
    });

    // Record consent on the server (evidence for audits)
    async function recordConsent(orderId){
      const CONSENT_VERSION = '1.0';
      const text = 'Autorizo a SERVI a guardar esta tarjeta y realizar cargos adicionales relacionados con mi servicio, previa confirmaci√≥n por WhatsApp. Si mi banco exige verificaci√≥n, se me pedir√° confirmarlo (3-D Secure). Puedo solicitar la eliminaci√≥n de mi m√©todo de pago en cualquier momento.';
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      const hash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
      await fetch(`/orders/${orderId}/consent`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          version: CONSENT_VERSION,
          text, hash,
          locale: navigator.language || 'es-MX',
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
        })
      });
    }


    form.addEventListener("submit", async (event) => {
        event.preventDefault(); // prevent page refresh first
        await stripeReady;
        const termsChecked = document.getElementById("terms-checkbox").checked;
        const consentChecked = document.getElementById("consent-checkbox").checked;
        if (!termsChecked) {
          alert("Debes aceptar los T√©rminos y Condiciones y el Aviso de Privacidad para continuar.");
          return;
        }


        submitBtn.disabled = true;
        spinner.style.display = "block";

        const order = await getOrder();
        if (!order) {
          alert("Orden no encontrada. Contacta a soporte.");
          spinner.style.display = "none";
          submitBtn.disabled = false;
          return;
        }
        const orderId = order.id;
        const clientSecret = order.client_secret;

        if (!clientSecret || !orderId) {
          alert("Link inv√°lido o incompleto. Por favor contacta a soporte.");
          spinner.style.display = "none";
          submitBtn.disabled = false;
          return;
        }

        const cardholder = document.getElementById("cardholder-name").value || "";
        if (document.getElementById("consent-checkbox").checked) {
          await recordConsent(orderId);
        }
        const result = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card, billing_details: { name: cardholder } }
        });

        if (result.error) {
          alert("Error: " + result.error.message);
          spinner.style.display = "none";
          submitBtn.disabled = false;
        } else if (result.paymentIntent.status === "succeeded" || result.paymentIntent.status === "requires_capture") {
          localStorage.setItem('orderId', String(orderId));
          window.location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        }
      });

  </script>
</body>

</html>
