<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
      * { box-sizing: border-box; }

      body {
        background-color: #000;
        color: #fff;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        line-height: 1.6;
      }

      .page {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .logo {
        max-width: 150px;
        margin-bottom: 20px;
      }

      .container {
        max-width: 400px;
        width: 100%;
        background: #111;
        padding: 36px 24px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      h2 {
        text-align: center;
        margin: 0;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: .2px;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: -15px;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        padding-top: 5px;
        margin-right: 30px;
      }

      #card-element {
        background-color: #222;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #444;
      }

      button {
        background-color: #fff;
        color: #000;
        border: none;
        padding: 11px;
        border-radius: 6px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: -5px;
      }

      #terms-checkbox {
      margin-left: 10px;
      }

      .terms-checkbox-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-wrap: nowrap;
      }

      .terms-label {
      font-size: 12px;
      color: #ccc;
      line-height: 1.4;
      flex: 1;
      word-break: break-word;
      }

      .terms-checkbox-wrapper input[type="checkbox"] {
        transform: scale(0.9);
        margin-top: -13px;
      }

      .terms-label a {
        color: rgb(255, 255, 255);
        text-decoration: underline;
      }

      .support {
        font-size: 12px;
        color: #ccc;
        text-align: center;
        margin-top: 16px;
      }

      .support a {
        color: rgb(255, 255, 255);
        text-decoration: none;
      }

      .footer {
        margin-top: 24px;
        text-align: center;
        color: #aaa;
        padding: 24px ;
      }

      .footer img {
        height: 32px;
        max-width: 100%;
        object-fit: contain;
      }
      .icon-input {
      position: relative;
      }

    .input-text {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px 12px 12px 43px; /* space for icon */
      color: #9ca3af;
      font-size: 16px;
      width: 100%;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

    .input-icon {
      position: absolute;
      top: 50%;
      left: 14px;
      bottom: 9px;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 14.1px;
      opacity: 0.17;
      pointer-events: none;
      }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
      }

    #service-summary {
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      }


    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
      }

    #spinner {
    display: none;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    color: #fff;
  }

  .spinner-circle {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  </style>

</head>
<body>
  <div class="page">
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Confirmar m√©todo de pago</h2>
      
      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando‚Ä¶</p>
      </div>

      <!-- Setup (save-card) UI mounts here when intentType === 'setup' -->
      <div id="payment-element" style="display:none;"></div>

      <div id="express-pay-container" style="display:none;">
        <div id="express-pay-button"></div>
      </div>

      <form id="payment-form">
        <div class="form-row">
          <div id="card-element"></div>
        </div>
        <div class="form-row icon-input">
            <input 
                type="text" 
                id="cardholder-name" 
                name="cardholder-name" 
                placeholder="Nombre del titular"
                class="input-text"
                required
            />
        </div>



        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox" class="terms-label">
              Al realizar tu pedido, aceptas nuestros
              <a href="https://serviservices.my.canva.site/helpcenter/#t√©rminos-y-condiciones" target="_blank">T√©rminos y Condiciones</a>
              y nuestro
              <a href="https://serviservices.my.canva.site/helpcenter/#aviso-de-privacidad" target="_blank">Aviso de Privacidad</a>.
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="consent-checkbox" />
            <label for="consent-checkbox" class="terms-label">
              Autorizo a SERVI a <strong>guardar esta tarjeta</strong> y realizar
              <strong>cargos adicionales</strong> relacionados con mi servicio
              (horas extra, piezas adicionales o correcciones), previa confirmaci√≥n por WhatsApp.
              <a href="#" id="consent-more">Ver detalles</a>
              <span id="consent-details" style="display:none"><br>
                ‚Ä¢ Datos guardados de forma segura en Stripe.<br>
                ‚Ä¢ Solo se aplicar√°n cargos cuando yo los apruebe por mensaje.<br>
                ‚Ä¢ Si mi banco exige verificaci√≥n, se me pedir√° confirmarlo (3-D Secure).<br>
                ‚Ä¢ Puedo solicitar la eliminaci√≥n de mi m√©todo de pago en cualquier momento.
              </span>
            </label>
          </div>
        </div>


        <button id="submit">Reservar servicio</button>
        
        <div id="spinner" style="display: none;">
          <div class="spinner-circle"></div>
        </div>
      </form>
    </div>

    <div class="support">
      ¬øNecesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    // Initialize Stripe only (no Elements yet)
    const stripeReady = (async () => {
      const resp = await fetch('/config/stripe');
      const { pk } = await resp.json();
      if (!pk) throw new Error('Missing STRIPE_PUBLISHABLE_KEY on server');
      window.stripe = Stripe(pk);
    })();

    // üÜï Fetch once, cache, and use everywhere
    let cachedOrder = null;
    async function getOrder() {
      if (cachedOrder) return cachedOrder;

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");
      if (!orderId) return null;

      const response = await fetch(`/order/${orderId}`);
      if (!response.ok) return null;

      cachedOrder = await response.json();
      return cachedOrder;
    }

    // init: fill summary + build Apple/Google Pay with real amount
    (async () => {
      await stripeReady;
      const order = await getOrder();
      if (!order) return;

      // Replace your existing formatFechaEs with this version:
      function formatFechaEs(dateOnly, dateTime) {
        // Prefer full timestamp for display (so we can show the hour)
        const raw = dateTime || dateOnly;
        if (!raw) return "‚Äî";

        // Accept "YYYY-MM-DD" or ISO-like values
        const d = new Date(raw);
        if (isNaN(d)) return String(raw);

        // (1) Date WITHOUT year
        const fecha = d.toLocaleDateString("es-MX", {
          weekday: "long",
          day: "2-digit",
          month: "long",
          // year intentionally omitted
        });
        const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);

        // (2) Time, only if we have a timestamp (service_datetime)
        // Force 12-hour with minutes, Spanish style (e.g., "4:00 p. m.")
        const showTime = !!dateTime;
        if (!showTime) return cap;

        const hora = d.toLocaleTimeString("es-MX", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true
        });

        return `${cap}, a las ${hora}`;
      }


      const servicio = (order.service_description || "servicio").trim();
      const fechaTexto = formatFechaEs(order.service_date, order.service_datetime);
      const monto = (Number(order.amount || 0) / 100);
      const montoTexto = monto.toLocaleString("es-MX", { style: "currency", currency: "MXN" });
      document.getElementById("service-summary").textContent =
        `Reserva de ${servicio} el ${fechaTexto}, por ${montoTexto}.`;

      // Helpers for showing/hiding areas
      const show = (sel) => (document.querySelector(sel).style.display = 'block');
      const hide = (sel) => (document.querySelector(sel).style.display = 'none');

      // We‚Äôll mount the correct Element depending on what the server says.
      const intentType = order.intentType;          // 'payment' | 'setup' | null
      const consentRequired = !!order.consent_required;
      const clientSecret = order.client_secret || null;

      // Grab existing containers
      const cardBox = document.getElementById('card-element');
      const payElBox = document.getElementById('payment-element');
      const expressWrap = document.getElementById('express-pay-container');

      // We‚Äôll reuse your #submit button and checkboxes
      const submitBtn = document.getElementById('submit');

      // ------------- CASE A: >7d gate hit, user hasn't given consent yet -------------
      if (consentRequired && !clientSecret && !intentType) {
        // Block payment UI; require consent first.
        hide('#card-element');
        hide('#payment-element');
        hide('#express-pay-container');

        // Change CTA text to make it clear
        submitBtn.textContent = 'Dar consentimiento y crear cuenta';
        submitBtn.dataset.mode = 'gate-consent';
        return; // submit handler will take it from here
      }

      // ------------- CASE B: Setup flow (save now); wallets allowed via Payment Element -------------
      if (intentType === 'setup' && clientSecret) {
        hide('#card-element');          // we won't use raw Card Element here
        hide('#express-pay-container'); // PR Button not used in setup
        show('#payment-element');

        // Create Elements in setup mode using the SetupIntent client secret
        const elements = (window.elements = (window.stripe).elements({
          clientSecret: clientSecret,
          locale: 'es',
          appearance: { theme: 'night' } // optional
        }));
        const paymentElement = (window.paymentElement = elements.create('payment', {
          // Wallets (Apple/Google) will appear automatically when available/enabled for the merchant
          // You can tweak layout here if you want
        }));
        paymentElement.mount('#payment-element');

        // Adjust button label
        submitBtn.textContent = 'Guardar m√©todo y crear cuenta';
        submitBtn.dataset.mode = 'confirm-setup';
        return;
      }

      // ------------- CASE C: Normal ‚â§7d payment (manual capture): keep Card Element + PR Button -------------
      if (intentType === 'payment' && clientSecret) {
        // Build Card Element
        const elements = (window.elements = (window.stripe).elements({ locale: 'es' }));
        const card = (window.card = elements.create('card', {
          style: {
            base: {
              fontFamily: '"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
              fontSize: '16px',
              color: '#ffffff',
              '::placeholder': { color: '#9ca3af' }
            },
            invalid: { color: '#ef4444' }
          },
          hidePostalCode: true
        }));
        card.mount('#card-element');

        // Express wallets remain for *payment* mode
        const paymentRequest = (window.paymentRequest = (window.stripe).paymentRequest({
          country: "MX",
          currency: "mxn",
          total: { label: "Servicio SERVI", amount: order.amount },
          requestPayerName: true,
          requestPayerEmail: true,
        }));
        const prButton = elements.create("paymentRequestButton", {
          paymentRequest,
          style: { paymentRequestButton: { type: "default", theme: "dark", height: "40px" } }
        });
        const can = await paymentRequest.canMakePayment();
        if (can) {
          show('#express-pay-container');
          prButton.mount("#express-pay-button");
          paymentRequest.on("paymentmethod", async (ev) => {
            const first = await (window.stripe).confirmCardPayment(
              clientSecret,
              { payment_method: ev.paymentMethod.id },
              { handleActions: false }
            );
            if (first.error) { ev.complete("fail"); alert(first.error.message); return; }
            ev.complete("success");
            const second = await (window.stripe).confirmCardPayment(clientSecret);
            if (second.error) { alert("Error al confirmar: " + second.error.message); return; }
            localStorage.setItem('orderId', String(order.id));
            window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
          });
        }

        submitBtn.textContent = 'Reservar servicio';
        submitBtn.dataset.mode = 'confirm-payment';
        return;
      }

      // Fallback
      alert('No se pudo inicializar el flujo de pago. Contacta a soporte.');
    })();
     
    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const spinner = document.getElementById("spinner");

    // Toggle consent details UI
    document.getElementById('consent-more').addEventListener('click', (e)=>{
      e.preventDefault();
      const box = document.getElementById('consent-details');
      box.style.display = box.style.display === 'none' ? 'inline' : 'none';
    });

    // Record consent on the server (evidence for audits)
    async function recordConsent(orderId){
      const CONSENT_VERSION = '1.0';
      const text = 'Autorizo a SERVI a guardar esta tarjeta y realizar cargos adicionales relacionados con mi servicio, previa confirmaci√≥n por WhatsApp. Si mi banco exige verificaci√≥n, se me pedir√° confirmarlo (3-D Secure). Puedo solicitar la eliminaci√≥n de mi m√©todo de pago en cualquier momento.';
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      const bytes = new Uint8Array(buf);
      const hash  = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
      await fetch(`/orders/${orderId}/consent`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          version: CONSENT_VERSION,
          text, hash,
          locale: navigator.language || 'es-MX',
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
        })
      });
    }


    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      await stripeReady;

      const termsChecked = document.getElementById("terms-checkbox").checked;
      const consentChecked = document.getElementById("consent-checkbox").checked;
      if (!termsChecked) {
        alert("Debes aceptar los T√©rminos y Condiciones y el Aviso de Privacidad para continuar.");
        return;
      }

      const order = await getOrder();
      if (!order) { alert("Orden no encontrada."); return; }

      const mode = document.getElementById("submit").dataset.mode || '';
      const spinner = document.getElementById("spinner");
      const submitBtn = document.getElementById("submit");
      submitBtn.disabled = true; spinner.style.display = "block";

      try {
        // GATE: user must consent first for >7d requests
        if (mode === 'gate-consent') {
          if (!consentChecked) {
            alert("Para reservar con m√°s de 5 d√≠as de anticipaci√≥n debes autorizar guardar tu m√©todo de pago.");
            return;
          }
          // Record consent ‚Üí server promotes order.kind from 'setup_required' to 'setup'
          await recordConsent(order.id);
          // Re-fetch order so we receive a SetupIntent client_secret
          cachedOrder = null;
          const updated = await getOrder();
          if (updated.intentType !== 'setup' || !updated.client_secret) {
            alert("No se pudo preparar el guardado de tarjeta. Intenta de nuevo.");
            return;
          }
          // Reload to let the init code mount the Payment Element
          location.reload();
          return;
        }

        // SETUP: confirm SetupIntent (saves wallet/card). Wallets appear inside Payment Element.
        if (mode === 'confirm-setup') {
          if (!consentChecked) {
            alert("Debes autorizar guardar tu m√©todo de pago para crear tu cuenta.");
            return;
          }
          const { error } = await (window.stripe).confirmSetup({
            elements: window.elements,
            redirect: 'if_required',
            confirmParams: {
              // optional: attach billing_details collected elsewhere
            }
          });
          if (error) { alert("No se pudo guardar el m√©todo: " + error.message); return; }
          // Success ‚Üí webhook will mark Status=Saved and kind='book'
          localStorage.setItem('orderId', String(order.id));
          window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
          return;
        }

        // PAYMENT: normal manual-capture payment intent (‚â§7d)
        if (mode === 'confirm-payment') {
          const cardholder = document.getElementById("cardholder-name").value || "";
          if (document.getElementById("consent-checkbox").checked) {
            await recordConsent(order.id); // lets Stripe save PM on capture later
          }
          const result = await (window.stripe).confirmCardPayment(order.client_secret, {
            payment_method: { card: window.card, billing_details: { name: cardholder } }
          });
          if (result.error) { alert("Error: " + result.error.message); return; }
          if (result.paymentIntent.status === "succeeded" || result.paymentIntent.status === "requires_capture") {
            localStorage.setItem('orderId', String(order.id));
            window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
            return;
          }
        }

        alert("No se pudo completar la operaci√≥n.");
      } finally {
        spinner.style.display = "none";
        submitBtn.disabled = false;
      }
    });


  </script>
</body>

</html>
