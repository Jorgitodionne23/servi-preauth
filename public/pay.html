<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
      * { box-sizing: border-box; }

      body {
        background-color: #000;
        color: #fff;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        line-height: 1.6;
      }

      .page {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .logo {
        max-width: 150px;
        margin-bottom: 20px;
      }

      .container {
        max-width: 400px;
        width: 100%;
        background: #111;
        padding: 36px 24px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      h2 {
        text-align: center;
        margin: 0;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: .2px;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: -15px;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        padding-top: 5px;
        margin-right: 30px;
      }

      #card-element {
        background-color: #222;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #444;
      }

      button {
        background-color: #fff;
        color: #000;
        border: none;
        padding: 11px;
        border-radius: 6px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: -5px;
      }

      #terms-checkbox {
      margin-left: 10px;
      }

      .terms-checkbox-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-wrap: nowrap;
      }

      .terms-label {
      font-size: 12px;
      color: #ccc;
      line-height: 1.4;
      flex: 1;
      word-break: break-word;
      }

      .terms-checkbox-wrapper input[type="checkbox"] {
        transform: scale(0.9);
        margin-top: -13px;
      }

      .terms-label a {
        color: rgb(255, 255, 255);
        text-decoration: underline;
      }

      .support {
        font-size: 12px;
        color: #ccc;
        text-align: center;
        margin-top: 16px;
      }

      .support a {
        color: rgb(255, 255, 255);
        text-decoration: none;
      }

      .footer {
        margin-top: 24px;
        text-align: center;
        color: #aaa;
        padding: 24px ;
      }

      .footer img {
        height: 32px;
        max-width: 100%;
        object-fit: contain;
      }
      .icon-input {
      position: relative;
      }

    .input-text {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px 12px 12px 43px;
      color: #9ca3af;
      font-size: 16px;
      width: 100%;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      }

    .input-icon {
      position: absolute;
      top: 50%;
      left: 14px;
      bottom: 9px;
      transform: translateY(-50%);
      color: #9ca3af;
      font-size: 14.1px;
      opacity: 0.17;
      pointer-events: none;
      }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
      }

    #service-summary {
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      }


    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
      }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin: 6px 0;
      font-size: 14px;
      color: #9ca3af;
    }

    .summary-row span:last-child {
      color: #fff;
      font-weight: 500;
    }

    .summary-row.total {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-row.total span:first-child {
      color: #fff;
    }

    .summary-note {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    #spinner {
    display: none;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    color: #fff;
  }

  .spinner-circle {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  </style>

</head>
<body>
  <div class="page">
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Confirmar método de pago</h2>
      
      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando…</p>
        <div class="summary-row" id="service-price-row" style="display:none;">
          <span>Precio del servicio</span>
          <span id="service-price">—</span>
        </div>
        <div class="summary-row" id="processing-fee-row" style="display:none;">
          <span>Comisión por procesamiento</span>
          <span id="processing-fee">—</span>
        </div>
        <div class="summary-row total" id="total-row" style="display:none;">
          <span>Total a pagar</span>
          <span id="summary-total">—</span>
        </div>
        <div class="summary-note" id="summary-note" style="display:none;">*IVA incluido</div>
      </div>

      <!-- Setup (save-card) UI mounts here when intentType === 'setup' -->
      <div id="payment-element" style="display:none;"></div>

      <div id="express-pay-container" style="display:none;">
        <div id="express-pay-button"></div>
      </div>

      <form id="payment-form">
        <div class="form-row">
          <div id="card-element"></div>
        </div>
        <div class="form-row icon-input">
            <input 
                type="text" 
                id="cardholder-name" 
                name="cardholder-name" 
                placeholder="Nombre del titular"
                class="input-text"
                required
            />
        </div>

        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox" class="terms-label">
              Al realizar tu pedido, aceptas nuestros
              <a href="https://serviservices.my.canva.site/helpcenter/#términos-y-condiciones" target="_blank">Términos y Condiciones</a>
              y nuestro
              <a href="https://serviservices.my.canva.site/helpcenter/#aviso-de-privacidad" target="_blank">Aviso de Privacidad</a>.
            </label>
          </div>
        </div>

        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="consent-checkbox" />
            <label for="consent-checkbox" class="terms-label">
              Autorizo a SERVI a <strong>guardar esta tarjeta</strong> y realizar
              <strong>cargos adicionales</strong> relacionados con mi servicio
              (horas extra, piezas adicionales o correcciones), previa confirmación por WhatsApp.
              <a href="#" id="consent-more">Ver detalles</a>
              <span id="consent-details" style="display:none"><br>
                • Datos guardados de forma segura en Stripe.<br>
                • Solo se aplicarán cargos cuando yo los apruebe por mensaje.<br>
                • Si mi banco exige verificación, se me pedirá confirmarlo (3-D Secure).<br>
                • Puedo solicitar la eliminación de mi método de pago en cualquier momento.
              </span>
            </label>
          </div>
        </div>

        <button id="submit">Reservar servicio</button>
        
        <div id="spinner" style="display: none;">
          <div class="spinner-circle"></div>
        </div>
      </form>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    // Initialize Stripe only (no Elements yet)
    const stripeReady = (async () => {
      const resp = await fetch('/config/stripe');
      const cfg = await resp.json();
      if (!cfg.pk) throw new Error('Missing STRIPE_PUBLISHABLE_KEY on server');
      window.stripe = Stripe(cfg.pk);
      return cfg;
    })();

    const mxnFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const formatMoneyFromCents = (value) => {
      const cents = Number(value || 0);
      return mxnFormatter.format(cents / 100);
    };
    const toCents = (value) => {
      const n = Number(value);
      return Number.isFinite(n) ? Math.round(n) : 0;
    };

    let processingFeeRules = [];
    let defaultProcessingFeeRuleId = null;
    let vatRate = 0.16;
    let stripeFeeVatRate = 0.16;
    let baseProviderCents = 0;
    let baseBookingCents = 0;
    let latestCardSnapshot = null;

    const pricingState = {
      providerAmountCents: 0,
      bookingFeeAmountCents: 0,
      processingFeeAmountCents: 0,
      vatAmountCents: 0,
      totalAmountCents: 0,
      serviceAmountCents: 0,
      ruleId: null,
      ruleLabel: '',
    };

    const summaryElements = {
      box: null,
      serviceRow: null,
      servicePrice: null,
      processingRow: null,
      processingPrice: null,
      totalRow: null,
      totalPrice: null,
      vatNote: null,
    };
    let cardPreviewSequence = 0;

    function normalizeCardSnapshot(card = {}) {
      return {
        brand: String(card.brand || '').toLowerCase(),
        funding: String(card.funding || '').toLowerCase(),
        country: String(card.country || '').toUpperCase(),
      };
    }

    function matchProcessingFeeRuleClient(card = {}) {
      if (!processingFeeRules.length) return null;
      const snapshot = normalizeCardSnapshot(card);
      for (const rule of processingFeeRules) {
        const match = rule.match || {};
        if (match.brand && String(match.brand).toLowerCase() !== snapshot.brand) continue;
        if (match.funding && String(match.funding).toLowerCase() !== snapshot.funding) continue;
        if (match.country) {
          const target = String(match.country).toUpperCase();
          if (target !== '*' && target !== snapshot.country) continue;
        }
        return rule;
      }
      return (
        processingFeeRules.find((rule) => rule.id === defaultProcessingFeeRuleId) ||
        processingFeeRules[0] ||
        null
      );
    }

    function computePricingPreviewClient(providerCents, bookingCents, rule) {
      if (!rule) return null;
      const baseCents = providerCents + bookingCents;
      const basePesos = baseCents / 100;
      const pEff = rule.percent * (1 + stripeFeeVatRate);
      const fEff = rule.fixed * (1 + stripeFeeVatRate);
      const denom = 1 - pEff * (1 + vatRate);
      const safeDenom = denom <= 0 ? 1 : denom;
      const processingPesos =
        basePesos <= 0 ? 0 : (pEff * (1 + vatRate) * basePesos + fEff) / safeDenom;
      const processingCents = Math.max(0, Math.round(processingPesos * 100));

      const vatBaseCents = baseCents + processingCents;
      const vatPesos = vatRate * (vatBaseCents / 100);
      const vatCents = Math.max(0, Math.round(vatPesos * 100));

      const totalCents = baseCents + processingCents + vatCents;
      const serviceAmountCents = baseCents + vatCents;

      return {
        providerAmountCents: providerCents,
        bookingFeeAmountCents: bookingCents,
        processingFeeAmountCents: processingCents,
        vatAmountCents: vatCents,
        totalAmountCents: totalCents,
        serviceAmountCents,
        ruleId: rule.id,
        ruleLabel: rule.label,
      };
    }

    function updateSummaryFromBreakdown(breakdown) {
      if (!breakdown) return;
      pricingState.providerAmountCents = breakdown.providerAmountCents ?? pricingState.providerAmountCents;
      pricingState.bookingFeeAmountCents = breakdown.bookingFeeAmountCents ?? pricingState.bookingFeeAmountCents;
      pricingState.processingFeeAmountCents =
        breakdown.processingFeeAmountCents ?? pricingState.processingFeeAmountCents;
      pricingState.vatAmountCents = breakdown.vatAmountCents ?? pricingState.vatAmountCents;
      pricingState.totalAmountCents = breakdown.totalAmountCents ?? pricingState.totalAmountCents;
      pricingState.serviceAmountCents = breakdown.serviceAmountCents ?? pricingState.serviceAmountCents;
      pricingState.ruleId = breakdown.ruleId || pricingState.ruleId;
      pricingState.ruleLabel = breakdown.ruleLabel || pricingState.ruleLabel;

      if (summaryElements.serviceRow && summaryElements.servicePrice) {
        if (pricingState.serviceAmountCents > 0) {
          summaryElements.servicePrice.textContent = formatMoneyFromCents(pricingState.serviceAmountCents);
          summaryElements.serviceRow.style.display = 'flex';
        } else {
          summaryElements.serviceRow.style.display = 'none';
        }
      }

      if (summaryElements.processingRow && summaryElements.processingPrice) {
        if (pricingState.processingFeeAmountCents > 0) {
          summaryElements.processingPrice.textContent = formatMoneyFromCents(
            pricingState.processingFeeAmountCents
          );
          summaryElements.processingRow.style.display = 'flex';
        } else {
          summaryElements.processingRow.style.display = 'none';
        }
      }

      if (summaryElements.totalRow && summaryElements.totalPrice) {
        if (pricingState.totalAmountCents > 0) {
          summaryElements.totalPrice.textContent = formatMoneyFromCents(pricingState.totalAmountCents);
          summaryElements.totalRow.style.display = 'flex';
        } else {
          summaryElements.totalRow.style.display = 'none';
        }
      }

      if (summaryElements.vatNote && summaryElements.box) {
        summaryElements.vatNote.style.display =
          pricingState.vatAmountCents > 0 ? 'block' : 'none';
        if (summaryElements.vatNote.parentElement !== summaryElements.box) {
          summaryElements.box.appendChild(summaryElements.vatNote);
        }
      }

      syncPaymentRequestTotal();
    }

    function syncPaymentRequestTotal() {
      if (!window.paymentRequest || typeof window.paymentRequest.update !== 'function') {
        return;
      }
      const amount = Number.isFinite(Number(pricingState.totalAmountCents))
        ? Number(pricingState.totalAmountCents)
        : 0;
      try {
        window.paymentRequest.update({
          total: { label: 'Servicio SERVI', amount },
        });
      } catch (err) {
        console.warn('No se pudo sincronizar el total con wallets:', err);
      }
    }

    // Fetch once, cache, and use everywhere
    let cachedOrder = null;
    let setupClientSecret = null;

    function mountCardElement() {
      if (window.card) return window.card;

      const elements = (window.elements = window.stripe.elements({ locale: 'es' }));
      const card = (window.card = elements.create('card', {
        style: {
          base: {
            fontFamily: '"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            fontSize: '16px',
            color: '#ffffff',
            '::placeholder': { color: '#9ca3af' }
          },
          invalid: { color: '#ef4444' }
        },
        hidePostalCode: true
      }));

      card.mount('#card-element');

      if (!window.__cardConfigured) {
        card.on('change', (event) => {
          const snapshot = {
            brand: event.brand || '',
            funding: event.card?.funding || '',
            country: event.card?.country || '',
          };
          latestCardSnapshot = snapshot;
          const rule = matchProcessingFeeRuleClient(snapshot);
          if (rule) {
            const preview = computePricingPreviewClient(baseProviderCents, baseBookingCents, rule);
            if (preview) {
              preview.ruleId = rule.id;
              preview.ruleLabel = rule.label;
              updateSummaryFromBreakdown(preview);
            }
          }
          if (event.complete) {
            const runSeq = ++cardPreviewSequence;
            refreshPricingForCompletedCard(runSeq).catch((err) => {
              console.warn('No se pudo actualizar el total dinámico:', err);
            });
          } else {
            cardPreviewSequence++;
          }
        });
        window.__cardConfigured = true;
      }

      return card;
    }

    async function refreshPricingForCompletedCard(runSeq) {
      await stripeReady;
      const order = await getOrder();
      if (!order) return;

      const cardholderInput = document.getElementById('cardholder-name');
      const cardholderName = (cardholderInput?.value || '').trim();

      const pmResult = await window.stripe.createPaymentMethod({
        type: 'card',
        card: window.card,
        billing_details: cardholderName ? { name: cardholderName } : {},
      });

      if (runSeq !== cardPreviewSequence) return;

      if (pmResult.error) {
        throw new Error(pmResult.error.message || pmResult.error);
      }

      latestCardSnapshot = normalizeCardSnapshot(pmResult.paymentMethod?.card || {});

      await applyPricingForPaymentMethod(order, pmResult.paymentMethod.id, { preview: true });
    }

    async function getOrder() {

      if (cachedOrder) return cachedOrder;

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");
      if (!orderId) return null;

      const response = await fetch(`/order/${orderId}`);
      if (!response.ok) return null;

      cachedOrder = await response.json();
      return cachedOrder;
    }

    // Format date helper
    function formatFechaEs(dateOnly, dateTime) {
      const raw = dateTime || dateOnly;
      if (!raw) return "—";

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      const fecha = d.toLocaleDateString("es-MX", {
        weekday: "long",
        day: "2-digit",
        month: "long",
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);

      const showTime = !!dateTime;
      if (!showTime) return cap;

      const hora = d.toLocaleTimeString("es-MX", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });

      return `${cap}, a las ${hora}`;
    }

    // Init: fill summary + mount appropriate payment UI
    (async () => {
      const config = await stripeReady;
      processingFeeRules = Array.isArray(config.processingFeeRules)
        ? config.processingFeeRules
        : [];
      defaultProcessingFeeRuleId = config.defaultProcessingFeeRule || null;
      if (Number.isFinite(Number(config.vatRate))) {
        vatRate = Number(config.vatRate);
      }
      if (Number.isFinite(Number(config.stripeFeeVatRate))) {
        stripeFeeVatRate = Number(config.stripeFeeVatRate);
      }

      const order = await getOrder();
      if (!order) return;

      summaryElements.box = document.querySelector(".summary-box");
      summaryElements.serviceRow = document.getElementById("service-price-row");
      summaryElements.servicePrice = document.getElementById("service-price");
      summaryElements.processingRow = document.getElementById("processing-fee-row");
      summaryElements.processingPrice = document.getElementById("processing-fee");
      summaryElements.totalRow = document.getElementById("total-row");
      summaryElements.totalPrice = document.getElementById("summary-total");
      summaryElements.vatNote = document.getElementById("summary-note");

      // ✅ ALWAYS show service summary (even when consent_required)
      const servicio = (order.service_description || "servicio").trim();
      const fechaTexto = formatFechaEs(order.service_date, order.service_datetime);
      document.getElementById("service-summary").textContent =
        `Reserva de ${servicio} el ${fechaTexto}.`;

      baseProviderCents = toCents(order.provider_amount ?? order.pricing?.provider_amount);
      baseBookingCents = toCents(order.booking_fee_amount ?? order.pricing?.booking_fee_amount);
      const initialProcessingCents = toCents(
        order.processing_fee_amount ?? order.pricing?.processing_fee_amount
      );
      const initialVatCents = toCents(order.vat_amount ?? order.pricing?.vat_amount);
      const initialTotalCents = toCents(order.amount ?? order.pricing?.total_amount);
      const serviceWithVatCents = baseProviderCents + baseBookingCents + initialVatCents;

      updateSummaryFromBreakdown({
        providerAmountCents: baseProviderCents,
        bookingFeeAmountCents: baseBookingCents,
        processingFeeAmountCents: initialProcessingCents,
        vatAmountCents: initialVatCents,
        totalAmountCents: initialTotalCents,
        serviceAmountCents: serviceWithVatCents,
        ruleId: order.processing_fee_rule || null,
        ruleLabel: '',
      });

      if (pricingState.ruleId && processingFeeRules.length) {
        const matchingRule = processingFeeRules.find((rule) => rule.id === pricingState.ruleId);
        if (matchingRule) pricingState.ruleLabel = matchingRule.label;
      }

      // Helpers
      const show = (sel) => (document.querySelector(sel).style.display = 'block');
      const hide = (sel) => (document.querySelector(sel).style.display = 'none');

      const intentType = order.intentType;
      const consentRequired = !!order.consent_required;
      let clientSecret = order.client_secret || null;
      const submitBtn = document.getElementById('submit');

      // ------------- CASE A: >5d gate (consent_required, no client_secret yet) -------------
      if (consentRequired && !clientSecret && !intentType) {
        hide('#payment-element');
        hide('#express-pay-container');

        mountCardElement();

        submitBtn.textContent = 'Reservar servicio';
        submitBtn.dataset.mode = 'confirm-setup';
        setupClientSecret = null;
        return;
      }


      // ------------- CASE B: Setup flow (save card via SetupIntent) -------------
      if (intentType === 'setup' && clientSecret) {
        hide('#payment-element');
        hide('#express-pay-container');

        mountCardElement();

        submitBtn.textContent = 'Reservar servicio';
        submitBtn.dataset.mode = 'confirm-setup';
        setupClientSecret = clientSecret;
        return;
      }


      // ------------- CASE C: Normal payment (manual capture PI) -------------
      if (intentType === 'payment' && clientSecret) {
        const card = mountCardElement();


        // Express wallets
        const paymentRequest = (window.paymentRequest = (window.stripe).paymentRequest({
          country: "MX",
          currency: "mxn",
          total: { label: "Servicio SERVI", amount: totalCents },
          requestPayerName: true,
          requestPayerEmail: true,
        }));
        const prButton = elements.create("paymentRequestButton", {
          paymentRequest,
          style: { paymentRequestButton: { type: "default", theme: "dark", height: "40px" } }
        });
        const can = await paymentRequest.canMakePayment();
        if (can) {
          show('#express-pay-container');
          prButton.mount("#express-pay-button");
          paymentRequest.on("paymentmethod", async (ev) => {
            try {
              const consentBox = document.getElementById("consent-checkbox");
              if (consentBox && consentBox.checked) {
                await recordConsent(order.id);
                await applyConsentToCurrentPI(order.id);
              }

              const pricingResp = await applyPricingForPaymentMethod(order, ev.paymentMethod.id);
              if (pricingResp.clientSecret) {
                clientSecret = pricingResp.clientSecret;
              }

              const first = await window.stripe.confirmCardPayment(
                clientSecret,
                { payment_method: ev.paymentMethod.id },
                { handleActions: false }
              );
              if (first.error) {
                ev.complete("fail");
                alert(first.error.message);
                return;
              }
              ev.complete("success");
              const second = await window.stripe.confirmCardPayment(clientSecret);
              if (second.error) {
                alert("Error al confirmar: " + second.error.message);
                return;
              }
              localStorage.setItem('orderId', String(order.id));
              window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
            } catch (error) {
              ev.complete("fail");
              alert(error.message || 'No se pudo confirmar el pago.');
            }
          });
        }

        submitBtn.textContent = 'Reservar servicio';
        submitBtn.dataset.mode = 'confirm-payment';
        return;
      }

      // Fallback
      alert('No se pudo inicializar el flujo de pago. Contacta a soporte.');
    })();
     
    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const spinner = document.getElementById("spinner");

    // Toggle consent details UI
    document.getElementById('consent-more').addEventListener('click', (e)=>{
      e.preventDefault();
      const box = document.getElementById('consent-details');
      box.style.display = box.style.display === 'none' ? 'inline' : 'none';
    });

    async function applyConsentToCurrentPI(orderId) {
      await fetch(`/orders/${encodeURIComponent(orderId)}/apply-consent-to-current-pi`, { method: 'POST' });
    }

    function applyServerBreakdownToOrder(order, data) {
      if (!data) return;
      order.amount = data.totalAmountCents ?? order.amount;
      order.processing_fee_amount = data.processingFeeAmountCents ?? order.processing_fee_amount;
      order.booking_fee_amount = data.bookingFeeAmountCents ?? order.booking_fee_amount;
      order.vat_amount = data.vatAmountCents ?? order.vat_amount;
      if (data.rule?.id) order.processing_fee_rule = data.rule.id;
      if (data.clientSecret) order.client_secret = data.clientSecret;
    }

    function breakdownFromServer(data) {
      return {
        providerAmountCents: data.providerAmountCents ?? baseProviderCents,
        bookingFeeAmountCents: data.bookingFeeAmountCents ?? baseBookingCents,
        processingFeeAmountCents: data.processingFeeAmountCents ?? pricingState.processingFeeAmountCents,
        vatAmountCents: data.vatAmountCents ?? pricingState.vatAmountCents,
        totalAmountCents: data.totalAmountCents ?? pricingState.totalAmountCents,
        serviceAmountCents:
          data.serviceAmountCents ??
          baseProviderCents + baseBookingCents + (data.vatAmountCents ?? pricingState.vatAmountCents),
        ruleId: data.rule?.id || pricingState.ruleId,
        ruleLabel: data.rule?.label || pricingState.ruleLabel,
      };
    }

    async function applyPricingForPaymentMethod(order, paymentMethodId, options = {}) {
      const { preview = false } = options;
      const resp = await fetch(`/orders/${encodeURIComponent(order.id)}/reprice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentMethodId, preview }),
      });
      const payload = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        throw new Error(payload.error || 'No se pudo recalcular las comisiones.');
      }
      if (!preview) {
        applyServerBreakdownToOrder(order, payload);
      }
      updateSummaryFromBreakdown(breakdownFromServer(payload));
      return payload;
    }

    // Record consent on the server
    async function recordConsent(orderId){
      const CONSENT_VERSION = '1.0';
      const text = 'Autorizo a SERVI a guardar esta tarjeta y realizar cargos adicionales relacionados con mi servicio, previa confirmación por WhatsApp. Si mi banco exige verificación, se me pedirá confirmarlo (3-D Secure). Puedo solicitar la eliminación de mi método de pago en cualquier momento.';
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      const bytes = new Uint8Array(buf);
      const hash  = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
      await fetch(`/orders/${orderId}/consent`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          version: CONSENT_VERSION,
          text, hash,
          locale: navigator.language || 'es-MX',
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
        })
      });
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      await stripeReady;

      const termsChecked = document.getElementById("terms-checkbox").checked;
      const consentChecked = document.getElementById("consent-checkbox").checked;

      const mode = submitBtn.dataset.mode || '';
      const missingAlerts = [];
      if (!termsChecked) {
        missingAlerts.push("Debes aceptar los Términos y Condiciones y el Aviso de Privacidad para continuar.");
      }
      if (mode === 'confirm-setup' && !consentChecked) {
        missingAlerts.push("Debes autorizar guardar tu método de pago para reserva con más de 5 días de anticipación.");
      }
      if (missingAlerts.length) {
        alert(missingAlerts.join('\n\n'));
        return;
      }

      const order = await getOrder();
      if (!order) { alert("Orden no encontrada."); return; }

      submitBtn.disabled = true;
      spinner.style.display = "block";

      try {
        // ========== CASE B: Setup confirmation ==========
        if (mode === 'confirm-setup') {
          if (!consentChecked) {
            alert("Debes autorizar guardar tu método de pago para crear tu cuenta.");
            return;
          }

          await recordConsent(order.id);

          if (!setupClientSecret) {
            cachedOrder = null;
            const refreshed = await getOrder();
            if (refreshed.intentType !== 'setup' || !refreshed.client_secret) {
              alert("No se pudo preparar el guardado de tarjeta. Intenta de nuevo.");
              return;
            }
            setupClientSecret = refreshed.client_secret;
          }

          const cardholder = document.getElementById("cardholder-name").value || "";
          const pmResult = await window.stripe.createPaymentMethod({
            type: 'card',
            card: window.card,
            billing_details: { name: cardholder },
          });
          if (pmResult.error) {
            alert("No se pudo guardar el método: " + pmResult.error.message);
            return;
          }

          const pricingResp = await applyPricingForPaymentMethod(order, pmResult.paymentMethod.id);
          if (pricingResp.clientSecret) {
            setupClientSecret = pricingResp.clientSecret;
          }

          const result = await window.stripe.confirmCardSetup(setupClientSecret, {
            payment_method: pmResult.paymentMethod.id,
          });

          if (result.error) {
            alert("No se pudo guardar el método: " + result.error.message);
            return;
          }

          localStorage.setItem('orderId', String(order.id));
          window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
          return;
        }

        // ========== CASE C: Normal payment confirmation ==========
        if (mode === 'confirm-payment') {
          const cardholder = document.getElementById("cardholder-name").value || "";

          const pmResult = await window.stripe.createPaymentMethod({
            type: 'card',
            card: window.card,
            billing_details: { name: cardholder },
          });
          if (pmResult.error) {
            alert("Error: " + pmResult.error.message);
            return;
          }

          if (consentChecked) {
            await recordConsent(order.id);
            await applyConsentToCurrentPI(order.id);
          }

          const pricingResp = await applyPricingForPaymentMethod(order, pmResult.paymentMethod.id);
          if (pricingResp.clientSecret) {
            clientSecret = pricingResp.clientSecret;
          } else if (order.client_secret) {
            clientSecret = order.client_secret;
          }

          const result = await window.stripe.confirmCardPayment(clientSecret, {
            payment_method: pmResult.paymentMethod.id,
          });

          if (result.error) {
            alert("Error: " + result.error.message);
            return;
          }

          if (
            result.paymentIntent.status === "succeeded" ||
            result.paymentIntent.status === "requires_capture"
          ) {
            localStorage.setItem('orderId', String(order.id));
            window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
            return;
          }
        }

        alert("No se pudo completar la operación.");
      } finally {
        spinner.style.display = "none";
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
