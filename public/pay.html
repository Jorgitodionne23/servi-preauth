<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
      * { box-sizing: border-box; }

      body {
        background-color: #000;
        color: #fff;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
        line-height: 1.6;
      }

      .page {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .logo {
        max-width: 150px;
        margin-bottom: 6px;
      }

      .container {
        max-width: 400px;
        width: 100%;
        background: #111;
        padding: 15px 24px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .container h2 {
        text-align: center;
        margin: 0;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: .2px;
      }
      .container > .summary-box {
        margin-top: -12px;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: -15px;
      }

      .form-row {
        display: flex;
        flex-direction: column;
        padding-top: 5px;
      }

      .form-label {
        font-size: 13px;
        font-weight: 500;
        color: #d1d5db;
        margin-bottom: 6px;
      }

      .card-fieldset {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .card-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .card-row .card-control {
        flex: 1 1 0%;
        min-width: 140px;
      }

      .card-control {
        flex: 1;
        background-color: #222;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 12px;
        min-height: 48px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        align-items: center;
        cursor: text;
      }

      .card-control > .__PrivateStripeElement,
      .card-control > .StripeElement,
      .card-control iframe {
        flex: 1 !important;
        width: 100% !important;
      }

      .card-control:hover {
        border-color: #666;
      }

      .card-control.is-focused {
        border-color: #888;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
      }

      .card-control.has-error {
        border-color: #ef4444;
      }

      button {
        background-color: #fff;
        color: #000;
        border: none;
        padding: 11px;
        border-radius: 6px;
        font-size: 17px;
        font-weight: 700;
        cursor: pointer;
        margin-bottom: -5px;
      }

      .form-row.checkbox-centered {
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
      }

      .terms-checkbox-wrapper {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        text-align: left;
        gap: 8px;
        max-width: 320px;
      }

      .terms-label {
        font-size: 12px;
        color: #ccc;
        line-height: 1.4;
        word-break: break-word;
      }

      .terms-checkbox-wrapper input[type="checkbox"] {
        transform: scale(0.9);
        margin: 2px 0 0 0;
        flex-shrink: 0;
      }

      .terms-label a {
        color: rgb(255, 255, 255);
        text-decoration: underline;
      }

      .consent-details {
        font-size: 11px;
        color: #aaa;
        line-height: 1.5;
      }

      .support {
        font-size: 12px;
        color: #ccc;
        text-align: center;
        margin-top: 16px;
      }

      .support a {
        color: rgb(255, 255, 255);
        text-decoration: none;
      }

      .footer {
        margin-top: -8px;
        text-align: center;
        color: #aaa;
        padding: 15px ;
      }

      .footer img {
        height: 32px;
        max-width: 100%;
        object-fit: contain;
      }

    .input-text {
      background-color: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;  /* ← CHANGED from "12px 12px 12px 43px" */
      color: #fff;  /* ← CHANGED from #9ca3af to match card element */
      font-size: 16px;
      width: 100%;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 24px;
      height: 48px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-text:hover {
      border-color: #666;
    }

    .input-text:focus {
      outline: none;
      border-color: #888;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
    }

    .input-text::placeholder {
      color: #9ca3af;
      font-size: 16px;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .summary-box {
      background-color: #1a1a1a;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: -4px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
      }

    #service-summary {
      margin: 0;
      line-height: 1.5;
      font-size: 15px;
      }


    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
      }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin: 6px 0;
      font-size: 14px;
      color: #9ca3af;
    }

    .summary-row span:last-child {
      color: #fff;
      font-weight: 500;
    }

    .summary-row.total {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-row.total span:first-child {
      color: #fff;
    }

    .summary-note {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }
    .notice {
      background-color: #1a1a1a;
      border: 1px solid #f87171;
      border-radius: 10px;
      padding: 14px;
      font-size: 14px;
      text-align: center;
      color: #fff;
    }
    .notice strong {
      display: block;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .notice small {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #fca5a5;
    }

    #spinner {
    display: none;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    color: #fff;
  }

  .spinner-circle {
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  </style>

</head>
<body>
  <div class="page">
    <a href="https://serviservices.my.canva.site/servi" target="_blank" rel="noopener">
      <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />
    </a>

    <div class="container">
      <h2>Confirmar método de pago</h2>
      
      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando…</p>
        <div class="summary-row total" id="total-row" style="display:none;">
          <span>Total a pagar</span>
          <span id="summary-total">—</span>
        </div>
        <div class="summary-note" id="summary-note" style="display:none;">*IVA incluido</div>
        <div class="summary-row" id="adjustment-reason-row" style="display:none;">
          <span>Motivo del ajuste</span>
          <span id="adjustment-reason">—</span>
        </div>
      </div>
      <div id="link-expired" class="notice" style="display:none;">
        <strong>Enlace expirado</strong>
        <span>Este enlace ha caducado. Solicita un nuevo enlace con tu concierge de SERVI.</span>
        <small id="link-expired-date" style="display:none;"></small>
      </div>

      <!-- Setup (save-card) UI mounts here when intentType === 'setup' -->
      <div id="payment-element" style="display:none;"></div>

      <div id="express-pay-container" style="display:none;">
        <div id="express-pay-button"></div>
      </div>

      <form id="payment-form">
        <div class="form-row">
          <label for="customer-email" class="form-label">Correo electrónico</label>
          <input
            type="email"
            id="customer-email"
            name="customer-email"
            placeholder="cliente@ejemplo.com"
            class="input-text"
            autocomplete="email"
            required
          />
        </div>

        <div class="form-row">
          <label for="card-number-element" class="form-label">Información de la tarjeta</label>
          <div class="card-fieldset">
            <div class="card-control" id="card-number-element"></div>
            <div class="card-row">
              <div class="card-control" id="card-expiry-element"></div>
              <div class="card-control" id="card-cvc-element"></div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <label for="cardholder-name" class="form-label">Nombre del titular</label>
          <input 
              type="text" 
              id="cardholder-name" 
              name="cardholder-name" 
              placeholder="Nombre del titular"
              class="input-text"
              autocomplete="cc-name"
              required
          />
        </div>

        <div class="form-row checkbox-centered">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox" class="terms-label">
              Al realizar tu pedido, aceptas nuestros
              <a href="https://serviservices.my.canva.site/helpcenter/#términos-y-condiciones" target="_blank">Términos y Condiciones</a>
              y nuestro
              <a href="https://serviservices.my.canva.site/helpcenter/#aviso-de-privacidad" target="_blank">Aviso de Privacidad</a>.
            </label>
          </div>
        </div>

        <div class="form-row checkbox-centered">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="consent-checkbox" />
            <label for="consent-checkbox" class="terms-label">
              <strong> Guardar como método de pago.</strong>
              <a href="#" id="consent-more">Ver detalles</a>
              <span id="consent-details" class="consent-details" style="display:none"><br>
                Autorizo a SERVI a guardar de forma segura en Stripe, esta tarjeta para cargos futuros relacionados con mi servicio.
              </span>
            </label>
          </div>
        </div>

        <button id="submit">Reservar servicio</button>
        
        <div id="spinner" style="display: none;">
          <div class="spinner-circle"></div>
        </div>
      </form>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <a href="https://stripe.com" target="_blank" rel="noopener">
      <img src="poweredbystripe.png" alt="Powered by Stripe" />
    </a>
  </div>

  <script>
    // Initialize Stripe only (no Elements yet)
    const stripeReady = (async () => {
      const resp = await fetch('/config/stripe');
      const { pk } = await resp.json();
      if (!pk) throw new Error('Missing STRIPE_PUBLISHABLE_KEY on server');
      window.stripe = Stripe(pk);
    })();

    const CHARGE_CURRENCY = 'mxn';
    const mxnFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const formatMoneyFromCents = (value) => {
      const cents = Number(value || 0);
      return mxnFormatter.format(cents / 100);
    };
    const toCents = (value) => {
      const n = Number(value);
      return Number.isFinite(n) ? Math.round(n) : 0;
    };

    const PREVIEW_KEY = 'serviSuccessPreview';
    const PREVENT_BACK_KEY = 'serviPreventBack';
    const COMPLETED_STATUSES = new Set(['scheduled', 'confirmed', 'captured']);
    const expiredBox = document.getElementById('link-expired');
    const expiredDateEl = document.getElementById('link-expired-date');

    function formatExpirationDate(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return null;
      return d.toLocaleString('es-MX', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showLinkExpired(expiresAtIso) {
      const formEl = document.getElementById('payment-form');
      if (formEl) formEl.style.display = 'none';
      const summaryBox = document.querySelector('.summary-box');
      if (summaryBox) summaryBox.style.display = 'none';
      if (expiredBox) expiredBox.style.display = 'block';
      if (expiredDateEl) {
        const formatted = formatExpirationDate(expiresAtIso);
        if (formatted) {
          expiredDateEl.textContent = `Venció el ${formatted}.`;
          expiredDateEl.style.display = 'block';
        } else {
          expiredDateEl.style.display = 'none';
        }
      }
    }

    function storeSuccessPreview(snapshot) {
      try {
        sessionStorage.setItem(PREVIEW_KEY, JSON.stringify(snapshot));
      } catch (_) {}
    }

    function setPreventBackLock(orderId) {
      if (!orderId) return;
      try {
        sessionStorage.setItem(PREVENT_BACK_KEY, String(orderId));
      } catch (_) {}
    }

    function redirectToSuccess(orderId) {
      if (!orderId) return;
      setPreventBackLock(orderId);
      window.location.replace(`/success?orderId=${encodeURIComponent(orderId)}`);
    }

    function redirectToBook(orderId) {
      if (!orderId) return;
      window.location.replace(`/book?orderId=${encodeURIComponent(orderId)}`);
    }

    function redirectIfCompleted(order) {
      if (!order || !order.id) return false;
      const status = String(order.status || '').trim().toLowerCase();
      if (!COMPLETED_STATUSES.has(status)) return false;
      redirectToSuccess(order.id);
      return true;
    }

    function redirectIfSavedCardFlow(order) {
      if (!order || !order.id) return false;
      const kind = String(order.kind || '').trim().toLowerCase();
      const hasSavedCard = !!order.saved_card || !!order.saved_payment_method_id;
      if (!hasSavedCard && kind !== 'book') return false;
      redirectToBook(order.id);
      return true;
    }

    function buildPreviewFromOrder(order, { totalCents, vatCents, reasonText }) {
      return {
        orderId: order.id || null,
        publicCode: order.public_code || null,
        totalCents: Number(totalCents || 0),
        providerCents: toCents(order.provider_amount ?? order.pricing?.provider_amount),
        bookingCents: toCents(order.booking_fee_amount ?? order.pricing?.booking_fee_amount),
        processingCents: toCents(order.processing_fee_amount ?? order.pricing?.processing_fee_amount),
        vatCents: Number.isFinite(vatCents) ? vatCents : toCents(order.vat_amount ?? order.pricing?.vat_amount),
        kind: order.kind || '',
        reason: reasonText || String(order.adjustment_reason || ''),
        serviceAddress: order.service_address || ''
      };
    }

    (function guardCompletedOrderAccess() {
      try {
        const params = new URLSearchParams(window.location.search);
        const currentOrderId = params.get('orderId');
        const lockedOrderId = sessionStorage.getItem(PREVENT_BACK_KEY);
        if (currentOrderId && lockedOrderId && currentOrderId === lockedOrderId) {
          redirectToSuccess(currentOrderId);
        }
      } catch (guardErr) {
        console.warn('Back-navigation guard failed', guardErr);
      }
    })();

    // Fetch once, cache, and use everywhere
    let cachedOrder = null;
    let setupClientSecret = null;

    function mountCardElement() {
      if (window.cardNumber && window.cardExpiry && window.cardCvc) {
        return window.cardNumber;
      }

      const elements = window.elements || window.stripe.elements({ locale: 'es' });
      window.elements = elements;

      const sharedStyle = {
        base: {
          fontFamily: '"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
          fontSize: '16px',
          color: '#ffffff',
          backgroundColor: '#222222',
          iconColor: '#9ca3af',
          caretColor: '#ffffff',
          '::placeholder': {
            color: '#9ca3af',
            fontSize: '16px'
          }
        },
        invalid: { color: '#ef4444' }
      };

      const cardNumber = elements.create('cardNumber', {
        style: sharedStyle,
        showIcon: true,
        iconStyle: 'solid',
        placeholder: 'Número de tarjeta'
      });
      const cardExpiry = elements.create('cardExpiry', {
        style: sharedStyle,
        placeholder: 'MM/AA'
      });
      const cardCvc = elements.create('cardCvc', {
        style: sharedStyle,
        placeholder: 'CVV'
      });

      const bindState = (element, selector) => {
        const node = document.querySelector(selector);
        if (!node) return;
        element.on('focus', () => node.classList.add('is-focused'));
        element.on('blur', () => node.classList.remove('is-focused'));
        element.on('change', (event) => {
          node.classList.toggle('has-error', !!event.error);
        });
      };

      cardNumber.mount('#card-number-element');
      cardExpiry.mount('#card-expiry-element');
      cardCvc.mount('#card-cvc-element');

      bindState(cardNumber, '#card-number-element');
      bindState(cardExpiry, '#card-expiry-element');
      bindState(cardCvc, '#card-cvc-element');

      window.cardNumber = cardNumber;
      window.cardExpiry = cardExpiry;
      window.cardCvc = cardCvc;
      window.card = cardNumber;

      return cardNumber;
    }

    async function getOrder() {

      if (cachedOrder) return cachedOrder;

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");
      if (!orderId) return null;

      const response = await fetch(`/order/${orderId}`);
      if (response.status === 410) {
        const payload = await response.json().catch(() => ({}));
        showLinkExpired(payload?.linkExpiresAt || payload?.link_expires_at || null);
        return null;
      }
      if (!response.ok) return null;

      cachedOrder = await response.json();
      if (redirectIfCompleted(cachedOrder)) {
        cachedOrder = null;
        return null;
      }
      if (redirectIfSavedCardFlow(cachedOrder)) {
        cachedOrder = null;
        return null;
      }
      return cachedOrder;
    }

    // Format date helper
    function formatFechaEs(dateOnly, dateTime) {
      const raw = dateTime || dateOnly;
      if (!raw) return "—";

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      const fecha = d.toLocaleDateString("es-MX", {
        weekday: "long",
        day: "2-digit",
        month: "long",
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);

      const showTime = !!dateTime;
      if (!showTime) return cap;

      const hora = d.toLocaleTimeString("es-MX", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });

      return `${cap}, a las ${hora}`;
    }

    async function syncProcessingFee(orderId, paymentIntentId, paymentMethodId, extras = {}) {
      if (!orderId || (!paymentIntentId && !paymentMethodId)) return;
      try {
        const payload = {};
        if (extras && typeof extras === 'object' && extras.billingEmail) {
          payload.billingEmail = extras.billingEmail;
        }
        if (paymentIntentId) payload.paymentIntentId = paymentIntentId;
        if (paymentMethodId) payload.paymentMethodId = paymentMethodId;
        await fetch(`/orders/${encodeURIComponent(orderId)}/refresh-fees`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn('No se pudo actualizar la comisión real de Stripe:', err);
      }
    }

    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const spinner = document.getElementById("spinner");
    const emailInput = document.getElementById("customer-email");
    const cardholderInput = document.getElementById("cardholder-name");

    // Init: fill summary + mount appropriate payment UI
    (async () => {
      await stripeReady;
      const order = await getOrder();
      if (!order) return;

      if (emailInput && order.client_email) {
        emailInput.value = order.client_email;
      }
      if (cardholderInput && order.client_name) {
        cardholderInput.value = order.client_name;
      }

      const isAdjustment = String(order.kind || '').toLowerCase() === 'adjustment';
      const reasonText = String(order.adjustment_reason || '').trim();
      const headerEl = document.querySelector('.container h2');
      const summaryTitleEl = document.querySelector('.summary-box h3');
      const summaryEl = document.getElementById("service-summary");
      const reasonRow = document.getElementById("adjustment-reason-row");
      const reasonValueEl = document.getElementById("adjustment-reason");

      if (isAdjustment && headerEl) headerEl.textContent = 'Confirmar ajuste';
      if (isAdjustment && summaryTitleEl) summaryTitleEl.textContent = 'Detalles del ajuste';

      // ✅ ALWAYS show service summary (even when consent_required)
      const servicio = (order.service_description || "servicio").trim();
      const fechaTexto = formatFechaEs(order.service_date, order.service_datetime);
      if (isAdjustment) {
        const parts = [];
        if (servicio) parts.push(`Ajuste para ${servicio}`);
        if (fechaTexto && fechaTexto !== '—') parts.push(`Servicio: ${fechaTexto}`);
        summaryEl.textContent = parts.length ? `${parts.join('. ')}.` : 'Ajuste pendiente de confirmación.';
        if (reasonRow) {
          reasonRow.style.display = 'flex';
          if (reasonValueEl) {
            reasonValueEl.textContent = reasonText || 'SERVI adjustment';
          }
        }
      } else {
        summaryEl.textContent = `${servicio} el ${fechaTexto}.`;
        if (reasonRow) reasonRow.style.display = 'none';
      }

      const summaryBox = document.querySelector(".summary-box");
      const totalRow = document.getElementById("total-row");
      const totalEl = document.getElementById("summary-total");
      const noteEl = document.getElementById("summary-note");
      const actionLabel = isAdjustment ? 'Confirmar ajuste' : 'Reservar servicio';

      const totalCents = toCents(order.amount ?? order.pricing?.total_amount);
      const vatCents = toCents(order.vat_amount ?? order.pricing?.vat_amount);

      if (totalCents > 0) {
        totalEl.textContent = formatMoneyFromCents(totalCents);
        totalRow.style.display = 'flex';
        noteEl.style.display = vatCents > 0 ? 'block' : 'none';
      } else {
        totalRow.style.display = 'none';
        noteEl.style.display = 'none';
      }

      if (noteEl && summaryBox) {
        summaryBox.appendChild(noteEl);
      }

      try {
        const previewSnapshot = buildPreviewFromOrder(order, { totalCents, vatCents, reasonText });
        storeSuccessPreview(previewSnapshot);
      } catch (_) {}

      // Helpers
      const show = (sel) => (document.querySelector(sel).style.display = 'block');
      const hide = (sel) => (document.querySelector(sel).style.display = 'none');

      const intentType = order.intentType;
      const consentRequired = !!order.consent_required;
      const clientSecret = order.client_secret || null;
      const submitBtn = document.getElementById('submit');

      // ------------- CASE A: >5d gate (consent_required, no client_secret yet) -------------
      if (consentRequired && !clientSecret && !intentType) {
        hide('#payment-element');
        hide('#express-pay-container');

        mountCardElement();

        submitBtn.textContent = actionLabel;
        submitBtn.dataset.mode = 'confirm-setup';
        setupClientSecret = null;
        return;
      }


      // ------------- CASE B: Setup flow (save card via SetupIntent) -------------
      if (intentType === 'setup' && clientSecret) {
        hide('#payment-element');
        hide('#express-pay-container');

        mountCardElement();

        submitBtn.textContent = actionLabel;
        submitBtn.dataset.mode = 'confirm-setup';
        setupClientSecret = clientSecret;
        return;
      }


      // ------------- CASE C: Normal payment (manual capture PI) -------------
      if (intentType === 'payment' && clientSecret) {
        const card = mountCardElement();


        // Express wallets
        const requestCurrency = CHARGE_CURRENCY;
        const paymentRequest = (window.paymentRequest = (window.stripe).paymentRequest({
          country: "MX",
          currency: requestCurrency,
          total: { label: "Servicio SERVI", amount: totalCents },
          requestPayerName: true,
          requestPayerEmail: true,
        }));
        const prButton = elements.create("paymentRequestButton", {
          paymentRequest,
          style: { paymentRequestButton: { type: "default", theme: "dark", height: "50px" } }
        });
        const can = await paymentRequest.canMakePayment();
        if (can) {
          show('#express-pay-container');
          prButton.mount("#express-pay-button");
          paymentRequest.on("paymentmethod", async (ev) => {
            const consentBox = document.getElementById("consent-checkbox");
            const rawEmail = emailInput?.value ?? ev.paymentMethod?.billing_details?.email ?? '';
            const emailValue = typeof rawEmail === 'string' ? rawEmail.trim() : '';
            if (consentBox && consentBox.checked) {
              await recordConsent(order.id, { billingEmail: emailValue });
              await applyConsentToCurrentPI(order.id);
            }

            const first = await (window.stripe).confirmCardPayment(
              clientSecret,
              { payment_method: ev.paymentMethod.id },
              { handleActions: false }
            );
            if (first.error) { ev.complete("fail"); alert(first.error.message); return; }
            ev.complete("success");
            const second = await (window.stripe).confirmCardPayment(clientSecret);
            if (second.error) { alert("Error al confirmar: " + second.error.message); return; }
            const piId = second.paymentIntent?.id;
            if (piId) {
              await syncProcessingFee(order.id, piId, null, { billingEmail: emailValue });
            }
            localStorage.setItem('orderId', String(order.id));
            window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
          });
        }

        submitBtn.textContent = actionLabel;
        submitBtn.dataset.mode = 'confirm-payment';
        return;
      }

      // Fallback
      alert('No se pudo inicializar el flujo de pago. Contacta a soporte.');
    })();
    // Toggle consent details UI
    document.getElementById('consent-more').addEventListener('click', (e)=>{
      e.preventDefault();
      const box = document.getElementById('consent-details');
      box.style.display = box.style.display === 'none' ? 'inline' : 'none';
    });

    async function applyConsentToCurrentPI(orderId) {
      await fetch(`/orders/${encodeURIComponent(orderId)}/apply-consent-to-current-pi`, { method: 'POST' });
    }

    // Record consent on the server
    async function recordConsent(orderId, extras = {}){
      const CONSENT_VERSION = '1.0';
      const text = 'Autorizo a SERVI a guardar esta tarjeta y realizar cargos adicionales relacionados con mi servicio, previa confirmación por WhatsApp. Si mi banco exige verificación, se me pedirá confirmarlo (3-D Secure). Puedo solicitar la eliminación de mi método de pago en cualquier momento.';
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      const bytes = new Uint8Array(buf);
      const hash  = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
      const payload = {
        version: CONSENT_VERSION,
        text,
        hash,
        locale: navigator.language || 'es-MX',
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
      };
      if (extras && typeof extras === 'object' && extras.billingEmail) {
        payload.billingEmail = extras.billingEmail;
      }
      await fetch(`/orders/${orderId}/consent`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      await stripeReady;

      const termsChecked = document.getElementById("terms-checkbox").checked;
      const consentChecked = document.getElementById("consent-checkbox").checked;
      const cardholder = (cardholderInput?.value || "").trim();
      const email = (emailInput?.value || "").trim();

      const mode = submitBtn.dataset.mode || '';
      const missingAlerts = [];
      if (!termsChecked) {
        missingAlerts.push("Debes aceptar los Términos y Condiciones y el Aviso de Privacidad para continuar.");
      }
      if (mode === 'confirm-setup' && !consentChecked) {
        missingAlerts.push("Debes autorizar guardar tu método de pago para reserva con más de 5 días de anticipación.");
      }
      if (missingAlerts.length) {
        alert(missingAlerts.join('\n\n'));
        return;
      }

      const order = await getOrder();
      if (!order) { alert("Orden no encontrada."); return; }

      submitBtn.disabled = true;
      spinner.style.display = "block";

      try {
        // ========== CASE B: Setup confirmation ==========
        if (mode === 'confirm-setup') {
          if (!consentChecked) {
            alert("Debes autorizar guardar tu método de pago para crear tu cuenta.");
            return;
          }

          await recordConsent(order.id, { billingEmail: email });

          if (!setupClientSecret) {
            cachedOrder = null;
            const refreshed = await getOrder();
            if (refreshed.intentType !== 'setup' || !refreshed.client_secret) {
              alert("No se pudo preparar el guardado de tarjeta. Intenta de nuevo.");
              return;
            }
            setupClientSecret = refreshed.client_secret;
          }

          const billingDetails = {};
          if (cardholder) billingDetails.name = cardholder;
          if (email) billingDetails.email = email;

          const result = await window.stripe.confirmCardSetup(setupClientSecret, {
            payment_method: { card: window.card, billing_details: billingDetails }
          });

          if (result.error) {
            alert("No se pudo guardar el método: " + result.error.message);
            return;
          }

          if (result.setupIntent?.payment_method) {
            await syncProcessingFee(order.id, null, result.setupIntent.payment_method, { billingEmail: email });
          }
          localStorage.setItem('orderId', String(order.id));
          window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
          return;
        }

        // ========== CASE C: Normal payment confirmation ==========
        if (mode === 'confirm-payment') {
          if (consentChecked) {
            await recordConsent(order.id, { billingEmail: email });
            await applyConsentToCurrentPI(order.id);
          }
          
          const result = await window.stripe.confirmCardPayment(order.client_secret, {
            payment_method: {
              card: window.card,
              billing_details: {
                ...(cardholder ? { name: cardholder } : {}),
                ...(email ? { email } : {})
              }
            }
          });
          
          if (result.error) {
            alert("Error: " + result.error.message);
            return;
          }
          
          if (result.paymentIntent.status === "succeeded" || result.paymentIntent.status === "requires_capture") {
            if (result.paymentIntent.id) {
              await syncProcessingFee(order.id, result.paymentIntent.id, null, { billingEmail: email });
            }
            localStorage.setItem('orderId', String(order.id));
            window.location.href = `/success?orderId=${encodeURIComponent(order.id)}`;
            return;
          }
        }

        alert("No se pudo completar la operación.");
      } finally {
        spinner.style.display = "none";
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
