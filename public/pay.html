<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago - SERVI</title>
  <script src="https://js.stripe.com/v3/"></script>
<style>
  * {
    box-sizing: border-box;
  }

  body {
    background-color: #000;
    color: #fff;
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    display: flex;
    flex-direction: column;
    min-height: 80vh;
  }

  .page {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .logo {
    max-width: 150px;
    margin-bottom: 20px;
  }

  .container {
    max-width: 400px;
    width: 100%;
    background: #111;
    padding: 36px 24px;
    border-radius: 12px;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  h2 {
    text-align: center;
    margin: 0;
    font-weight: 510;
    font-size: 22px;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-top: -15px;
  }

  .form-row {
    display: flex;
    flex-direction: column;
    padding-left: 0px;
    padding-top: 5px;
  }

  #card-element {
    background-color: #222;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #444;
  }

  button {
    background-color: #fff;
    color: #000;
    border: none;
    padding: 11px;
    border-radius: 6px;
    font-size: 17px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: -5px;
  }

  #terms-checkbox {
  margin-left: 7px;
  }

  .terms-checkbox-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0px;
    text-align: center;
    flex-wrap: nowrap;
  }

  .terms-label {
  font-size: 11px;
  color: #ccc;
  line-height: 1.4;
  flex: 1;
  word-break: break-word;
}
  .terms-checkbox-wrapper input[type="checkbox"] {
    transform: scale(0.9);
    margin-top: -13px;
    margin-right: -3px;
  }

  .terms-label a {
    color: rgb(255, 255, 255);
    text-decoration: underline;
  }

  .support {
    font-size: 12px;
    color: #ccc;
    text-align: center;
    margin-top: 16px;
  }

  .support a {
    color: rgb(255, 255, 255);
    text-decoration: none;
  }

  .footer {
    margin-top: 24px;
    text-align: center;
    color: #aaa;
    padding: 24px ;
  }

  .footer img {
    height: 32px;
    max-width: 100%;
    object-fit: contain;
  }
  .icon-input {
  position: relative;
}

.input-text {
  background-color: #222;
  border: 1px solid #444;
  border-radius: 6px;
  padding: 12px 12px 12px 36px; /* space for icon */
  color: white;
  font-size: 14px;
  width: 100%;
}

.input-icon {
  position: absolute;
  top: 50%;
  left: 14px;
  bottom: 9px;
  transform: translateY(-50%);
  color: #fff;
  font-size: 12px;
  opacity: 0.2;
  pointer-events: none;
}

.summary-box {
  background-color: #1a1a1a;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: -5px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
  font-size: 14px;
}

.summary-box h3 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 18px;
  color: #fff;
}

</style>


</head>
<body>
  <div class="page">
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Confirmar mÃ©todo de pago</h2>
      
      <div class="summary-box">
        <h3>Resumen de tu solicitud</h3>
        <p><strong>Cliente:</strong> <span id="client-name">Cargando...</span></p>
        <p><strong>Servicio:</strong> <span id="service-desc">Cargando...</span></p>
        <p><strong>Total:</strong> $<span id="amount">0.00</span> MXN</p>
      </div>

      <div id="express-pay-container" style="display:none;">
        <div id="express-pay-button"></div>
      </div>

      <form id="payment-form">
        <div class="form-row">
          <div id="card-element"></div>
        </div>
        <div class="form-row icon-input">
            <input 
                type="text" 
                id="cardholder-name" 
                name="cardholder-name" 
                placeholder="Nombre del titular"
                class="input-text"
                required
            />
            <span class="input-icon">ðŸ‘¤</span>
        </div>



        <div class="form-row">
          <div class="terms-checkbox-wrapper">
            <input type="checkbox" id="terms-checkbox" />
            <label for="terms-checkbox" class="terms-label">
              Al realizar tu pedido, aceptas nuestros
              <a href="https://serviservices.my.canva.site/helpcenter/#tÃ©rminos-y-condiciones" target="_blank">TÃ©rminos y Condiciones</a>
              y nuestro
              <a href="https://serviservices.my.canva.site/helpcenter/#aviso-de-privacidad" target="_blank">Aviso de Privacidad</a>.
            </label>
          </div>
        </div>

        <button id="submit">Reservar servicio</button>
        <div id="spinner" class="spinner" style="display: none;">Procesando...</div>
      </form>
    </div>

    <div class="support">
      Â¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    const stripe = Stripe("pk_test_51QzK6tG7utWo2rQvhFzSBxh59IMDentv5zN7jfKWtf5vkFiGkcuEENhumOpKGjkf33tGqrL3b3o05tp0DDvcJn4r00pQcvaQXR");
    const elements = stripe.elements();
    const style = { base: { color: "#fff" } };
    const card = elements.create("card", { style, hidePostalCode: true });
    card.mount("#card-element");

    // ðŸ†• Fetch once, cache, and use everywhere
    let cachedOrder = null;
    async function getOrder() {
      if (cachedOrder) return cachedOrder;

      const urlParams = new URLSearchParams(window.location.search);
      const orderId = urlParams.get("orderId");
      if (!orderId) return null;

      const response = await fetch(`https://servi-preauth.onrender.com/order/${orderId}`);
      if (!response.ok) return null;

      cachedOrder = await response.json();
      return cachedOrder;
    }

    // init: fill summary + build Apple/Google Pay with real amount
    (async () => {
      const order = await getOrder();
      if (!order) return;

      // Fill summary box
      document.getElementById("client-name").textContent = order.client_name || "â€”";
      document.getElementById("service-desc").textContent = order.service_description || "â€”";
      document.getElementById("amount").textContent = (order.amount / 100).toFixed(2);

      // Create paymentRequest using the actual amount
      window.paymentRequest = stripe.paymentRequest({
        country: "MX",
        currency: "mxn",
        total: { label: "Servicio SERVI", amount: order.amount },
        requestPayerName: true,
        requestPayerEmail: true,
      });

      const prButton = elements.create("paymentRequestButton", {
        paymentRequest: window.paymentRequest,
        style: {
          paymentRequestButton: { type: "default", theme: "dark", height: "40px" }
        }
      });

      const can = await window.paymentRequest.canMakePayment();
      if (can) {
        document.getElementById("express-pay-container").style.display = "block";
        prButton.mount("#express-pay-button");
      }
    })();


     window.paymentRequest?.on("paymentmethod", async (ev) => {
      const order = await getOrder();
      if (!order) {
        ev.complete ("fail");
        alert("Orden no encontrada. Contacta a soporte.");
        return;
      }
      const orderId = order.id;
      const clientSecret = order.client_secret;

      const { error } = await stripe.confirmCardPayment(
        clientSecret,
        { payment_method: ev.paymentMethod.id },
        { handleActions: false }
      );

      if (error) {
        ev.complete("fail");
        alert(error.message);
      } else {
        ev.complete("success");
        const result = await stripe.confirmCardPayment(clientSecret);
        if (result.error) {
          alert("Error al confirmar: " + result.error.message);
        } else {
          const finalOrderId = orderId || "undefined";
          window.location.href = `/success.html?orderId=${finalOrderId}`;
        }
      }
    });

    const form = document.getElementById("payment-form");
    const submitBtn = document.getElementById("submit");
    const spinner = document.getElementById("spinner");

    form.addEventListener("submit", async (event) => {
        event.preventDefault(); // prevent page refresh first
        const termsChecked = document.getElementById("terms-checkbox").checked;
        if (!termsChecked) {
          alert("Debes aceptar los TÃ©rminos y Condiciones y el Aviso de Privacidad para continuar.");
          return;
        }

        submitBtn.disabled = true;
        spinner.style.display = "block";

        const order = await getOrder();
        if (!order) {
          alert("Orden no encontrada. Contacta a soporte.");
          spinner.style.display = "none";
          submitBtn.disabled = false;
          return;
        }
        const orderId = order.id;
        const clientSecret = order.client_secret;

        if (!clientSecret || !orderId) {
          alert("Link invÃ¡lido o incompleto. Por favor contacta a soporte.");
          spinner.style.display = "none";
          submitBtn.disabled = false;
          return;
        }

        const cardholder = document.getElementById("cardholder-name").value || "";
        const result = await stripe.confirmCardPayment(clientSecret, {
          payment_method: { card, billing_details: { name: cardholder } }
        });

        if (result.error) {
          alert("Error: " + result.error.message);
          spinner.style.display = "none";
          submitBtn.disabled = false;
        } else if (result.paymentIntent.status === "succeeded" || result.paymentIntent.status === "requires_capture") {
          const finalOrderId = orderId || "undefined";
          window.location.href = `/success.html?orderId=${finalOrderId}`;
        }
      });

  </script>
</body>

</html>
