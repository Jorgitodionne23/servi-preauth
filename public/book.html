<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Purpose: 1-click “Review & Book” for saved clients using their stored card, with 3DS fallback and Billing Portal. -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservar - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <!-- Same font as pay.html -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    /* === COPY of pay.html look & feel (only additions are noted) === */
    * { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 80vh;
      line-height: 1.6;
    }

    .page {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo {
      max-width: 150px;
      margin-bottom: 20px;
    }

    .container {
      max-width: 400px;
      width: 100%;
      background: #111;
      padding: 36px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      text-align: center;
      margin: 0;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
    }
    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
    }
    #service-summary { margin: 0; line-height: 1.5; font-size: 15px; }

    .method-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      background-color: #1a1a1a;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #222;
    }

    .two-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 11px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .ghost {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
    }

    .note {
      font-size: 12px;
      color: #ccc;
      margin: 0;
    }

    .support {
      font-size: 12px;
      color: #ccc;
      text-align: center;
      margin-top: 16px;
    }
    .support a { color: #fff; text-decoration: none; }

    .footer {
      margin-top: 24px;
      text-align: center;
      color: #aaa;
      padding: 24px;
    }
    .footer img {
      height: 32px;
      max-width: 100%;
      object-fit: contain;
    }

    /* Spinner (same visual language) */
    #spinner {
      display: none;
      text-align: center;
      font-size: 14px;
      color: #fff;
    }
    .spinner-circle {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
  </style>
</head>

<body>
  <div class="page">
    <!-- Same header logo as pay.html -->
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Revisa y confirma tu reserva</h2>

      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando…</p>
      </div>

      <div class="method-line">
        <span>Método de pago</span>
        <strong id="card-mask">—</strong>
      </div>

      <div class="two-buttons">
        <button id="btn-book">Reservar</button>
        <button id="btn-manage" class="ghost">Administrar métodos de pago</button>
      </div>

      <p class="note">Se usará tu método guardado. Puedes cambiarlo desde el portal.</p>

      <div id="spinner">
        <div class="spinner-circle"></div>
      </div>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <!-- Stripe lockup identical to pay.html -->
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script type="module">
    // Minimal helpers
    const $ = (sel) => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const orderId = params.get('orderId');

    if (!orderId) {
      alert('Falta el parámetro orderId.');
      throw new Error('Missing orderId');
    }

    // Load Stripe publishable key
    const { pk } = await fetch('/config/stripe').then(r => r.json());
    if (!pk) { alert('Stripe no está configurado.'); throw new Error('Missing Stripe key'); }
    const stripe = Stripe(pk);

    // Get order (expects saved_card and (if needed) client_secret for 3DS)
    const res = await fetch(`/order/${encodeURIComponent(orderId)}`);
    if (!res.ok) { alert('Orden no encontrada.'); throw new Error('Order not found'); }
    const order = await res.json();

    // If no saved card, fallback to full payment form
    if (!order?.saved_card) {
      // Extra guard: if server returns 409 later, we still redirect from the click handler.
      location.href = `/pay?orderId=${encodeURIComponent(orderId)}`;
    }

    // Prefer richer display if server provides it
    const fechaTexto = formatFecha(order);
    const servicio = (order.service_description || "servicio").trim();
    const monto = Number(order.amount || 0) / 100;
    const montoTexto = monto.toLocaleString("es-MX", { style: "currency", currency: "MXN" });
    $('#service-summary').textContent = `Reserva de ${servicio} el ${fechaTexto}, por ${montoTexto}.`;

    // Saved card mask (brand + last4 + expiry if available)
    const sc = order.saved_card || {};
    const brand = String(sc.brand || 'Tarjeta').toUpperCase();
    const exp = (sc.exp_month && sc.exp_year)
      ? ` • vence ${String(sc.exp_month).padStart(2,'0')}/${String(sc.exp_year).slice(-2)}`
      : '';
    $('#card-mask').textContent = `${brand} •••• ${sc.last4 || '----'}${exp}`;

   // If PI window not open yet (>7 days), keep button ENABLED but change copy
    if (order.kind === 'book' && order.preauth_window_open === false) {
      const btn = document.querySelector('#btn-book');
      btn.disabled = false; // keep clickable
      btn.textContent = 'Confirmar reserva (cargo 7 días antes)';
    }



    function formatFecha(orderObj) {
      const dateOnly  = orderObj.service_date || null;
      const dateTime  = orderObj.service_datetime || null;
      const raw = dateTime || dateOnly;
      if (!raw) return "—";

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      // Date WITHOUT year
      const fecha = d.toLocaleDateString("es-MX", {
        weekday: "long",
        day: "2-digit",
        month: "long",
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);

      // Show time only when we actually have a timestamp (service_datetime)
      if (!dateTime) return cap;

      const hora = d.toLocaleTimeString("es-MX", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });

      return `${cap}, a las ${hora}`;
    }


    // Record consent (audit trail) — harmless if already recorded
    async function recordConsent() {
      const text = `Autorizo el cargo por ${montoTexto} a mi tarjeta •••• ${sc.last4 || ''}`;
      try {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
        const hash = [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
        await fetch(`/orders/${encodeURIComponent(orderId)}/consent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            version: 'v1', text, hash,
            locale: navigator.language || 'es-MX',
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
          })
        });
      } catch {}
    }

    // Button: Reservar (off-session with saved card; 3DS fallback)
    $('#btn-book').onclick = async () => {
      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');

      btnBook.disabled = true;
      btnManage.disabled = true;
      $('#spinner').style.display = 'block';

      await recordConsent();

      const r = await fetch('/confirm-with-saved', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId })
      });

      // ✅ Success (off-session authorized/captured)
      if (r.status === 200) {
        location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      if (r.status === 409) {
        const out = await r.json().catch(() => ({}));
        alert(out.message || 'Tu servicio quedó programado. Realizaremos la preautorización 7 días antes de la fecha.');
        location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      // 3DS required → confirm in browser
      const out = await r.json().catch(() => ({}));
      if (r.status === 402 && out?.clientSecret) {
        const result = await stripe.confirmCardPayment(out.clientSecret);
        if (result.error) {
          alert(result.error.message || 'Error de autenticación');
          $('#spinner').style.display = 'none';
          btnBook.disabled = false;
          btnManage.disabled = false;
        } else {
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        }
        return;
      }

      // Other errors
      alert(out?.error || 'No se pudo confirmar el pago.');
      $('#spinner').style.display = 'none';
      btnBook.disabled = false;
      btnManage.disabled = false;
    };


    // Button: Administrar pago (Stripe Billing Portal)
    $('#btn-manage').onclick = async () => {
      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');
      btnBook.disabled = true;
      btnManage.disabled = true;

      try {
        const r = await fetch('/billing-portal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId, returnUrl: location.href })
        });

        const out = await r.json().catch(() => ({}));
        if (r.ok && out?.url) {
          location.href = out.url; // Stripe Billing Portal
          return;
        }
        alert(out?.error || out?.message || 'No se pudo abrir el portal de pago.');
      } catch {
        alert('No se pudo abrir el portal de pago.');
      } finally {
        btnBook.disabled = false;
        btnManage.disabled = false;
      }
    };
  </script>
</body>
</html>
