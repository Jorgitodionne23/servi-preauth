<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Purpose: 1-click “Review & Book” for saved clients using their stored card, with 3DS fallback and Billing Portal. -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservar - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <!-- Same font as pay.html -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    /* === COPY of pay.html look & feel (only additions are noted) === */
    * { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 80vh;
      line-height: 1.6;
    }

    .page {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo {
      max-width: 150px;
      margin-bottom: 20px;
    }

    .container {
      max-width: 400px;
      width: 100%;
      background: #111;
      padding: 36px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      text-align: center;
      margin: 0;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
    }
    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
    }
    #service-summary { margin: 0; line-height: 1.5; font-size: 15px; }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin: 6px 0;
      font-size: 14px;
      color: #9ca3af;
    }

    .summary-row span:last-child {
      color: #fff;
      font-weight: 500;
    }

    .summary-row.total {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-row.total span:first-child {
      color: #fff;
    }

    .summary-note {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .method-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      background-color: #1a1a1a;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #222;
    }

    .two-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 11px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .ghost {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
    }

    .note {
      font-size: 12px;
      color: #ccc;
      margin: 0;
    }

    .support {
      font-size: 12px;
      color: #ccc;
      text-align: center;
      margin-top: 16px;
    }
    .support a { color: #fff; text-decoration: none; }

    .footer {
      margin-top: 24px;
      text-align: center;
      color: #aaa;
      padding: 24px;
    }
    .footer img {
      height: 32px;
      max-width: 100%;
      object-fit: contain;
    }

    /* Spinner (same visual language) */
    #spinner {
      display: none;
      text-align: center;
      font-size: 14px;
      color: #fff;
    }
    .spinner-circle {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
  </style>
</head>

<body>
  <div class="page">
    <!-- Same header logo as pay.html -->
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Revisa y confirma tu reserva</h2>

  <div class="summary-box">
    <h3>Detalles de tu reserva</h3>
    <p id="service-summary">Cargando…</p>
    <div class="summary-row total" id="total-row" style="display:none;">
      <span>Total a pagar</span>
      <span id="summary-total">—</span>
    </div>
    <div class="summary-row" id="adjustment-reason-row" style="display:none;">
      <span>Motivo del ajuste</span>
      <span id="adjustment-reason">—</span>
    </div>
    <div class="summary-note" id="summary-note" style="display:none;">*IVA incluido</div>
  </div>

      <div class="method-line">
        <span>Método de pago</span>
        <strong id="card-mask">—</strong>
      </div>

      <div class="two-buttons">
        <button id="btn-book">Reservar</button>
        <button id="btn-manage" class="ghost">Administrar métodos de pago</button>
      </div>

      <p class="note">Se usará tu método guardado. Puedes cambiarlo desde el portal.</p>

      <div id="spinner">
        <div class="spinner-circle"></div>
      </div>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <!-- Stripe lockup identical to pay.html -->
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script>
    // Minimal helpers
    const $ = (sel) => document.querySelector(sel);
    const mxnFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const formatMoneyFromCents = (value) => mxnFormatter.format((Number(value || 0)) / 100);
    const toCents = (value) => {
      const n = Number(value);
      return Number.isFinite(n) ? Math.round(n) : 0;
    };
    const PREVIEW_KEY = 'serviSuccessPreview';
    const PREVENT_BACK_KEY = 'serviPreventBack';
    const COMPLETED_STATUSES = new Set(['scheduled', 'confirmed', 'captured']);

    function storeSuccessPreview(snapshot) {
      try {
        sessionStorage.setItem(PREVIEW_KEY, JSON.stringify(snapshot));
      } catch (_) {}
    }

    function setPreventBackLock(orderId) {
      if (!orderId) return;
      try {
        sessionStorage.setItem(PREVENT_BACK_KEY, String(orderId));
      } catch (_) {}
    }

    function redirectToSuccess(orderId) {
      if (!orderId) return;
      setPreventBackLock(orderId);
      window.location.replace(`/success?orderId=${encodeURIComponent(orderId)}`);
    }

    function redirectIfCompleted(order) {
      if (!order || !order.id) return false;
      const status = String(order.status || '').trim().toLowerCase();
      if (!COMPLETED_STATUSES.has(status)) return false;
      redirectToSuccess(order.id);
      return true;
    }

    function buildPreviewFromOrder(order, { totalCents, vatCents, reasonText }) {
      return {
        orderId: order.id || null,
        publicCode: order.public_code || null,
        totalCents: Number(totalCents || 0),
        providerCents: toCents(order.provider_amount ?? order.pricing?.provider_amount),
        bookingCents: toCents(order.booking_fee_amount ?? order.pricing?.booking_fee_amount),
        processingCents: toCents(order.processing_fee_amount ?? order.pricing?.processing_fee_amount),
        vatCents: Number.isFinite(vatCents) ? vatCents : toCents(order.vat_amount ?? order.pricing?.vat_amount),
        kind: order.kind || '',
        reason: reasonText || String(order.adjustment_reason || ''),
        serviceAddress: order.service_address || ''
      };
    }

    (function guardCompletedOrderAccess() {
      try {
        const params = new URLSearchParams(window.location.search);
        const currentOrderId = params.get('orderId');
        const lockedOrderId = sessionStorage.getItem(PREVENT_BACK_KEY);
        if (currentOrderId && lockedOrderId && currentOrderId === lockedOrderId) {
          redirectToSuccess(currentOrderId);
        }
      } catch (guardErr) {
        console.warn('Back-navigation guard failed', guardErr);
      }
    })();

    function formatFecha(orderObj) {
      const dateOnly = orderObj.service_date || null;
      const dateTime = orderObj.service_datetime || null;
      const raw = dateTime || dateOnly;
      if (!raw) return '—';

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      const fecha = d.toLocaleDateString('es-MX', {
        weekday: 'long',
        day: '2-digit',
        month: 'long'
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);
      if (!dateTime) return cap;

      const hora = d.toLocaleTimeString('es-MX', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      return `${cap}, a las ${hora}`;
    }

    async function syncProcessingFee(orderId, paymentIntentId, paymentMethodId) {
      if (!orderId || (!paymentIntentId && !paymentMethodId)) return;
      try {
        const payload = {};
        if (paymentIntentId) payload.paymentIntentId = paymentIntentId;
        if (paymentMethodId) payload.paymentMethodId = paymentMethodId;
        await fetch(`/orders/${encodeURIComponent(orderId)}/refresh-fees`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn('No se pudo actualizar la comisión real de Stripe:', err);
      }
    }

    async function initBookPage() {
      const params = new URLSearchParams(location.search);
      const orderId = params.get('orderId');
      if (!orderId) {
        alert('Falta el parámetro orderId.');
        throw new Error('missing_order_id');
      }

      const stripeResp = await fetch('/config/stripe');
      const { pk } = await stripeResp.json().catch(() => ({}));
      if (!pk) {
        alert('Stripe no está configurado.');
        throw new Error('missing_stripe_pk');
      }
      const stripe = Stripe(pk);

      const res = await fetch(`/order/${encodeURIComponent(orderId)}`);
      if (!res.ok) {
        alert('Orden no encontrada.');
        throw new Error('order_not_found');
      }
      const order = await res.json();

      if (redirectIfCompleted(order)) return;

      if (!order?.saved_card) {
        location.href = `/pay?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      const isAdjustment = String(order.kind || '').toLowerCase() === 'adjustment';
      const reasonText = String(order.adjustment_reason || '').trim();

      if (isAdjustment) {
        const heading = document.querySelector('.container h2');
        const summaryTitle = document.querySelector('.summary-box h3');
        if (heading) heading.textContent = 'Confirmar ajuste';
        if (summaryTitle) summaryTitle.textContent = 'Detalles del ajuste';
      }

      const fechaTexto = formatFecha(order);
      const servicio = (order.service_description || 'servicio').trim();
      const summaryEl = $('#service-summary');
      const summaryCopy = (() => {
        if (!isAdjustment) {
          return `Reserva de ${servicio} el ${fechaTexto}.`;
        }
        const parts = [];
        if (servicio) parts.push(`Ajuste para ${servicio}`);
        if (fechaTexto && fechaTexto !== '—') parts.push(`Servicio: ${fechaTexto}`);
        return parts.length ? `${parts.join('. ')}.` : 'Ajuste pendiente de confirmación.';
      })();
      if (summaryEl) summaryEl.textContent = summaryCopy;

      const reasonRow = document.getElementById('adjustment-reason-row');
      const reasonValue = document.getElementById('adjustment-reason');
      if (isAdjustment && reasonRow) {
        reasonRow.style.display = 'flex';
        if (reasonValue) reasonValue.textContent = reasonText || 'SERVI adjustment';
      } else if (reasonRow) {
        reasonRow.style.display = 'none';
      }

      if (isAdjustment) {
        const noteCopy = document.querySelector('.note');
        if (noteCopy) {
          noteCopy.textContent = 'Se usará tu método guardado para este ajuste. Puedes cambiarlo desde el portal.';
        }
      }

      const summaryBox = document.querySelector('.summary-box');
      const totalRow = document.getElementById('total-row');
      const totalEl = document.getElementById('summary-total');
      const noteEl = document.getElementById('summary-note');

      const totalCents = toCents(order.amount ?? order.pricing?.total_amount);
      const vatCents = toCents(order.vat_amount ?? order.pricing?.vat_amount);
      const totalFormatted = formatMoneyFromCents(totalCents);

      if (totalRow && totalEl) {
        if (totalCents > 0) {
          totalEl.textContent = totalFormatted;
          totalRow.style.display = 'flex';
          if (noteEl) noteEl.style.display = vatCents > 0 ? 'block' : 'none';
        } else {
          totalRow.style.display = 'none';
          if (noteEl) noteEl.style.display = 'none';
        }
      }

      if (noteEl && summaryBox) {
        summaryBox.appendChild(noteEl);
      }

      try {
        const previewSnapshot = buildPreviewFromOrder(order, { totalCents, vatCents, reasonText });
        storeSuccessPreview(previewSnapshot);
      } catch (_) {}

      const sc = order.saved_card || {};
      const brand = String(sc.brand || 'Tarjeta').toUpperCase();
      const exp = sc.exp_month && sc.exp_year
        ? ` • vence ${String(sc.exp_month).padStart(2, '0')}/${String(sc.exp_year).slice(-2)}`
        : '';
      const maskEl = $('#card-mask');
      if (maskEl) maskEl.textContent = `${brand} •••• ${sc.last4 || '----'}${exp}`;

      if (order.kind === 'book' && order.preauth_window_open === false) {
        const btn = document.querySelector('#btn-book');
        if (btn) {
          btn.disabled = false;
          btn.textContent = isAdjustment ? 'Confirmar ajuste' : 'Confirmar reserva';
        }
      }

      async function recordConsent() {
        const reasonPhrase = isAdjustment ? 'este ajuste' : 'mi reserva';
        const text = `Autorizo el cargo por ${totalFormatted} correspondiente a ${reasonPhrase} a mi tarjeta •••• ${sc.last4 || ''}`;
        try {
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
          const bytes = new Uint8Array(buf);
          const hash = Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
          await fetch(`/orders/${encodeURIComponent(orderId)}/consent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              version: 'v1',
              text,
              hash,
              locale: navigator.language || 'es-MX',
              tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
            })
          });
        } catch {}
      }

      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');
      const spinner = $('#spinner');
      if (!btnBook || !btnManage) return;

      if (isAdjustment) {
        btnBook.textContent = 'Confirmar ajuste';
      }

      btnBook.addEventListener('click', async () => {
        btnBook.disabled = true;
        btnManage.disabled = true;
        if (spinner) spinner.style.display = 'block';

        await recordConsent();

        const r = await fetch('/confirm-with-saved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId })
        });

        const payload = await r.json().catch(() => ({}));

        if (r.status === 200) {
          if (payload?.paymentIntentId || payload?.paymentMethodId) {
            await syncProcessingFee(orderId, payload?.paymentIntentId || null, payload?.paymentMethodId || null);
          }
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          return;
        }

        if (r.status === 409) {
          if (payload?.error === 'no_saved_card') {
            alert(payload?.message || 'Necesitamos que actualices tu método de pago para continuar.');
            const fallback = `/pay?orderId=${encodeURIComponent(orderId)}`;
            location.href = payload?.redirect || fallback;
            return;
          }
          if (payload?.paymentMethodId || payload?.paymentIntentId) {
            await syncProcessingFee(orderId, payload?.paymentIntentId || null, payload?.paymentMethodId || null);
          }
          const scheduledMsg = isAdjustment
            ? 'Tu ajuste quedó programado. Realizaremos la preautorización 12 horas antes de la fecha.'
            : 'Tu servicio quedó programado. Realizaremos la preautorización 12 horas antes de la fecha.';
          alert(payload?.message || scheduledMsg);
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          return;
        }

        if (r.status === 402 && payload?.clientSecret) {
          const result = await stripe.confirmCardPayment(payload.clientSecret);
          if (result.error) {
            alert(result.error.message || 'Error de autenticación');
            if (spinner) spinner.style.display = 'none';
            btnBook.disabled = false;
            btnManage.disabled = false;
          } else {
            const piId = result.paymentIntent?.id || null;
            const pmId = payload?.paymentMethodId || null;
            if (piId || pmId) {
              await syncProcessingFee(orderId, piId, pmId);
            }
            location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          }
          return;
        }

        alert(payload?.error || 'No se pudo confirmar el pago.');
        if (spinner) spinner.style.display = 'none';
        btnBook.disabled = false;
        btnManage.disabled = false;
      });

      btnManage.addEventListener('click', async () => {
        btnBook.disabled = true;
        btnManage.disabled = true;

        try {
          const r = await fetch('/billing-portal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, returnUrl: location.href })
          });

          const out = await r.json().catch(() => ({}));
          if (r.ok && out?.url) {
            location.href = out.url;
            return;
          }
          alert(out?.error || out?.message || 'No se pudo abrir el portal de pago.');
        } catch {
          alert('No se pudo abrir el portal de pago.');
        } finally {
          btnBook.disabled = false;
          btnManage.disabled = false;
        }
      });
    }

    initBookPage().catch((err) => {
      console.error('Book page init failed:', err);
      if (!window.__BOOK_ALERT_SHOWN__) {
        window.__BOOK_ALERT_SHOWN__ = true;
        alert('No se pudo cargar la reserva. Actualiza la página o contacta a soporte.');
      }
    });
  </script>
</body>
</html>
