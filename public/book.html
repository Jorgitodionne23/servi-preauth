<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Purpose: 1-click “Review & Book” for saved clients using their stored card, with 3DS fallback and Billing Portal. -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservar - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <!-- Same font as pay.html -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    /* === COPY of pay.html look & feel (only additions are noted) === */
    * { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 80vh;
      line-height: 1.6;
    }

    .page {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo {
      max-width: 150px;
      margin-bottom: 20px;
    }

    .container {
      max-width: 400px;
      width: 100%;
      background: #111;
      padding: 36px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      text-align: center;
      margin: 0;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
    }
    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
    }
    #service-summary { margin: 0; line-height: 1.5; font-size: 15px; }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin: 6px 0;
      font-size: 14px;
      color: #9ca3af;
    }

    .summary-row span:last-child {
      color: #fff;
      font-weight: 500;
    }

    .summary-row.total {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-row.total span:first-child {
      color: #fff;
    }

    .summary-note {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }
    .notice {
      background-color: #1a1a1a;
      border: 1px solid #f87171;
      border-radius: 10px;
      padding: 14px;
      font-size: 14px;
      text-align: center;
      color: #fff;
    }
    .notice strong {
      display: block;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .notice small {
      display: block;
      margin-top: 6px;
      font-size: 12px;
      color: #fca5a5;
    }

    .method-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      background-color: #1a1a1a;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #222;
      gap: 10px;
    }
    .method-card {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-brand-icon {
      width: 42px;
      height: 28px;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      overflow: hidden;
    }
    .card-brand-icon.is-visible {
      display: inline-flex;
    }
    .card-brand-icon svg {
      width: 100%;
      height: 100%;
      display: block;
      border-radius: 4px;
    }
    .card-text {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
      gap: 2px;
    }
    .card-mask {
      font-size: 15px;
      font-weight: 600;
    }
    .card-expiration {
      font-size: 12px;
      color: #9ca3af;
    }

    .two-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 11px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .ghost {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
    }

    .note {
      font-size: 12px;
      color: #ccc;
      margin: 0;
    }

    .support {
      font-size: 12px;
      color: #ccc;
      text-align: center;
      margin-top: 16px;
    }
    .support a { color: #fff; text-decoration: none; }

    .footer {
      margin-top: 5px;
      text-align: center;
      color: #aaa;
      padding: 24px;
    }
    .footer img {
      height: 32px;
      max-width: 100%;
      object-fit: contain;
    }

    /* Spinner (same visual language) */
    #spinner {
      display: none;
      text-align: center;
      font-size: 14px;
      color: #fff;
    }
    .spinner-circle {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
  </style>
</head>

<body>
  <div class="page">
    <!-- Same header logo as pay.html -->
    <a href="https://serviservices.my.canva.site/servi" target="_blank" rel="noopener">
      <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />
    </a>

    <div class="container">
      <h2>Revisa y confirma tu reserva</h2>

  <div class="summary-box">
    <h3>Detalles de tu reserva</h3>
    <p id="service-summary">Cargando…</p>
    <div class="summary-row total" id="total-row" style="display:none;">
      <span>Total a pagar</span>
      <span id="summary-total">—</span>
    </div>
    <div class="summary-row" id="adjustment-reason-row" style="display:none;">
      <span>Motivo del ajuste</span>
      <span id="adjustment-reason">—</span>
    </div>
    <div class="summary-note" id="summary-note" style="display:none;">*IVA incluido</div>
  </div>
  <div id="link-expired" class="notice" style="display:none;">
    <strong>Enlace expirado</strong>
    <span>Este enlace ha caducado. Solicita un nuevo enlace con tu concierge de SERVI.</span>
    <small id="link-expired-date" style="display:none;"></small>
  </div>

      <div class="method-line">
        <span>Método de pago</span>
        <div class="method-card">
          <span class="card-brand-icon" id="card-brand-icon" aria-hidden="true"></span>
          <div class="card-text">
            <strong id="card-mask" class="card-mask">—</strong>
            <span id="card-expiration" class="card-expiration"> </span>
          </div>
        </div>
      </div>

      <div class="two-buttons">
        <button id="btn-book">Reservar</button>
        <button id="btn-manage" class="ghost">Administrar métodos de pago</button>
      </div>

      <p class="note">Se usará tu método guardado. Puedes cambiarlo desde el portal.</p>

      <div id="spinner">
        <div class="spinner-circle"></div>
      </div>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <!-- Stripe lockup identical to pay.html -->
    <a href="https://stripe.com" target="_blank" rel="noopener">
      <img src="poweredbystripe.png" alt="Powered by Stripe" />
    </a>
  </div>

  <script>
    // Minimal helpers
    const $ = (sel) => document.querySelector(sel);
    const mxnFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const formatMoneyFromCents = (value) => mxnFormatter.format((Number(value || 0)) / 100);
    const toCents = (value) => {
      const n = Number(value);
      return Number.isFinite(n) ? Math.round(n) : 0;
    };
    const MERIDIEM_REGEX = /\b([ap])\.\s*m\.?/gi;
    const enforceUpperMeridiem = (value) => {
      if (typeof value !== 'string') return value;
      return value.replace(MERIDIEM_REGEX, (_, meridiem) => `${meridiem.toUpperCase()}.M.`);
    };
    const PREVIEW_KEY = 'serviSuccessPreview';
    const PREVENT_BACK_KEY = 'serviPreventBack';
    const COMPLETED_STATUSES = new Set(['scheduled', 'confirmed', 'captured']);
    const expiredBox = document.getElementById('link-expired');
    const expiredDateEl = document.getElementById('link-expired-date');
    const CARD_BRAND_ICONS = {
      visa: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#1A1F71"></rect><path fill="#fff" d="M9.112 8.262L5.97 15.758H3.92L2.374 9.775c-.094-.368-.175-.503-.461-.658C1.447 8.864.677 8.627 0 8.479l.046-.217h3.3a.904.904 0 01.894.764l.817 4.338 2.018-5.102zm8.033 5.049c.008-1.979-2.736-2.088-2.717-2.972.006-.269.262-.555.822-.628a3.66 3.66 0 011.913.336l.34-1.59a5.207 5.207 0 00-1.814-.333c-1.917 0-3.266 1.02-3.278 2.479-.012 1.079.963 1.68 1.698 2.04.756.367 1.01.603 1.006.931-.005.504-.602.725-1.16.734-.975.015-1.54-.263-1.992-.473l-.351 1.642c.453.208 1.289.39 2.156.398 2.037 0 3.37-1.006 3.377-2.564m5.061 2.447H24l-1.565-7.496h-1.656a.883.883 0 00-.826.55l-2.909 6.946h2.036l.405-1.12h2.488zm-2.163-2.656l1.02-2.815.588 2.815zm-8.16-4.84l-1.603 7.496H8.34l1.605-7.496z"/></svg>`,
      mastercard: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#111"></rect><circle cx="10" cy="12" r="5.2" fill="#EB001B"></circle><circle cx="14" cy="12" r="5.2" fill="#F79E1B" opacity="0.9"></circle><path d="M12 6.8a5.2 5.2 0 010 10.4 5.2 5.2 0 010-10.4z" fill="#FF5F00"></path></svg>`,
      americanexpress: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#016FD0"></rect><path fill="#fff" d="M16.015 14.378c0-.32-.135-.496-.344-.622-.21-.12-.464-.135-.81-.135h-1.543v2.82h.675v-1.027h.72c.24 0 .39.024.478.125.12.13.104.38.104.55v.35h.66v-.555c-.002-.25-.017-.376-.108-.516-.06-.08-.18-.18-.33-.234l.02-.008c.18-.072.48-.297.48-.747zm-.87.407l-.028-.002c-.09.053-.195.058-.33.058h-.81v-.63h.824c.12 0 .24 0 .33.05.098.048.156.147.15.255 0 .12-.045.215-.134.27zM20.297 15.837H19v.6h1.304c.676 0 1.05-.278 1.05-.884 0-.28-.066-.448-.187-.582-.153-.133-.392-.193-.73-.207l-.376-.015c-.104 0-.18 0-.255-.03-.09-.03-.15-.105-.15-.21 0-.09.017-.166.09-.21.083-.046.177-.066.272-.06h1.23v-.602h-1.35c-.704 0-.958.437-.958.84 0 .9.776.855 1.407.87.104 0 .18.015.225.06.046.03.082.106.082.18 0 .077-.035.15-.08.18-.06.053-.15.07-.277.07zM0 0v10.096L.81 8.22h1.75l.225.464V8.22h2.043l.45 1.02.437-1.013h6.502c.295 0 .56.057.756.236v-.23h1.787v.23c.307-.17.686-.23 1.12-.23h2.606l.24.466v-.466h1.918l.254.465v-.466h1.858v3.948H20.87l-.36-.6v.585h-2.353l-.256-.63h-.583l-.27.614h-1.213c-.48 0-.84-.104-1.08-.24v.24h-2.89v-.884c0-.12-.03-.12-.105-.135h-.105v1.036H6.067v-.48l-.21.48H4.69l-.202-.48v.465H2.235l-.256-.624H1.4l-.256.624H0V24h23.786v-7.108c-.27.135-.613.18-.973.18H21.09v-.255c-.21.165-.57.255-.914.255H14.71v-.9c0-.12-.018-.12-.12-.12h-.075v1.022h-1.8v-1.066c-.298.136-.643.15-.928.136h-.214v.915h-2.18l-.54-.617-.57.6H4.742v-3.93h3.61l.518.602.554-.6h2.412c.28 0 .74.03.942.225v-.24h2.177c.202 0 .644.045.903.225v-.24h3.265v.24c.163-.164.508-.24.803-.24h1.89v.24c.194-.15.464-.24.84-.24h1.176V0H0zM21.156 14.955c.004.005.006.012.01.016.01.01.024.01.032.02l-.042-.035zM23.828 13.082h.065v.555h-.065zM23.865 15.03v-.005c-.03-.025-.046-.048-.075-.07-.15-.153-.39-.215-.764-.225l-.36-.012c-.12 0-.194-.007-.27-.03-.09-.03-.15-.105-.15-.21 0-.09.03-.16.09-.204.076-.045.15-.05.27-.05h1.223v-.588h-1.283c-.69 0-.96.437-.96.84 0 .9.78.855 1.41.87.104 0 .18.015.224.06.046.03.076.106.076.18 0 .07-.034.138-.09.18-.045.056-.136.07-.27.07h-1.288v.605h1.287c.42 0 .734-.118.9-.36h.03c.09-.134.135-.3.135-.523 0-.24-.045-.39-.135-.526zM18.597 14.208v-.583h-2.235V16.458h2.235v-.585h-1.57v-.57h1.533v-.584h-1.532v-.51M13.51 8.787h.685V11.6h-.684zM13.126 9.543l-.007.006c0-.314-.13-.5-.34-.624-.217-.125-.47-.135-.81-.135H10.43v2.82h.674v-1.034h.72c.24 0 .39.03.487.12.122.136.107.378.107.548v.354h.677v-.553c0-.25-.016-.375-.11-.516-.09-.107-.202-.19-.33-.237.172-.07.472-.3.472-.75zm-.855.396h-.015c-.09.054-.195.056-.33.056H11.1v-.623h.825c.12 0 .24.004.33.05.09.04.15.128.15.25s-.047.22-.134.266zM15.92 9.373h.632v-.6h-.644c-.464 0-.804.105-1.02.33-.286.3-.362.69-.362 1.11 0 .512.123.833.36 1.074.232.238.645.31.97.31h.78l.255-.627h1.39l.262.627h1.36v-2.11l1.272 2.11h.95l.002.002V8.786h-.684v1.963l-1.18-1.96h-1.02V11.4L18.11 8.744h-1.004l-.943 2.22h-.3c-.177 0-.362-.03-.468-.134-.125-.15-.186-.36-.186-.662 0-.285.08-.51.194-.63.133-.135.272-.165.516-.165zm1.668-.108l.464 1.118v.002h-.93l.466-1.12zM2.38 10.97l.254.628H4V9.393l.972 2.205h.584l.973-2.202.015 2.202h.69v-2.81H6.118l-.807 1.904-.876-1.905H3.343v2.663L2.205 8.787h-.997L.01 11.597h.72l.26-.626h1.39zm-.688-1.705l.46 1.118-.003.002h-.915l.457-1.12zM11.856 13.62H9.714l-.85.923-.825-.922H5.346v2.82H8l.855-.932.824.93h1.302v-.94h.838c.6 0 1.17-.164 1.17-.945l-.006-.003c0-.78-.598-.93-1.128-.93zM7.67 15.853l-.014-.002H6.02v-.557h1.47v-.574H6.02v-.51H7.7l.733.82-.764.824zm2.642.33l-1.03-1.147 1.03-1.108v2.253zm1.553-1.258h-.885v-.717h.885c.24 0 .42.098.42.344 0 .243-.15.372-.42.372zM9.967 9.373v-.586H7.73V11.6h2.237v-.58H8.4v-.564h1.527V9.88H8.4v-.507"/></svg>`,
      dinersclub: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#0079BE"></rect><path fill="#fff" d="M10.463 1.627h2.69C18.822 1.627 24 5.903 24 12.09c0 5.658-5.176 10.283-10.848 10.283h-2.69C4.723 22.373 0 17.75 0 12.09 0 5.905 4.723 1.626 10.463 1.627zm6.043 10.355a6.026 6.026 0 00-3.866-5.618V17.6a6.025 6.025 0 003.866-5.618zm-8.176 5.616V6.365a6.03 6.03 0 00-3.863 5.617 6.028 6.028 0 003.863 5.616z"/></svg>`,
      discover: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#111"></rect><path fill="#fff" d="M14.58 12a2.023 2.023 0 1 1-2.025-2.023h.002c1.118 0 2.023.906 2.023 2.023zm-5.2-2.001c-1.124 0-2.025.884-2.025 1.99 0 1.118.878 1.984 2.007 1.984.319 0 .593-.063.93-.221v-.873c-.296.297-.559.416-.895.416-.747 0-1.277-.542-1.277-1.312 0-.73.547-1.306 1.243-1.306.354 0 .622.126.93.428v-.873a1.898 1.898 0 0 0-.913-.233zm-3.352 1.545c-.445-.165-.576-.273-.576-.479 0-.239.233-.422.553-.422.222 0 .405.091.598.308l.388-.508a1.665 1.665 0 0 0-1.117-.422c-.673 0-1.186.467-1.186 1.089 0 .524.239.792.936 1.043.291.103.438.171.513.217a.456.456 0 0 1 .222.394c0 .308-.245.536-.576.536-.354 0-.639-.177-.809-.507l-.479.461c.342.502.752.724 1.317.724.771 0 1.311-.513 1.311-1.249-.002-.603-.252-.876-1.095-1.185zM3.472 13.887h.742v-3.803h-.742zm12.702-1.248l-1.014-2.554h-.81l1.614 3.9h.399l1.643-3.9h-.804l-1.028 2.554zm2.166 1.248h2.104v-.644h-1.362v-1.027h1.312v-.644h-1.312v-.844h1.362v-.644H18.34zm3.38-1.616l1.197 1.602H22.8l-1.027-1.528h-.097v1.528h-.741v-3.803h1.1c.855 0 1.346.411 1.346 1.123 0 .583-.308.965-.866 1.078zm.103-1.038c0-.37-.251-.563-.713-.563h-.228v1.152h.217c.473 0 .724-.207.724-.589z"/><circle cx="19.2" cy="12" r="2.6" fill="#F58220"></circle></svg>`,
      jcb: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect width="24" height="24" rx="4" fill="#111"></rect><path fill="#0A6FBE" d="M10.414 5.248c-3.676-.164-4.72 1.329-4.72 2.901 0 1.571 1.044 3.065 4.72 2.9.886-.04 1.827-.27 1.827-.27v-.956c-.463.224-1.022.456-1.74.51-1.382.095-2.256-.516-2.256-1.609 0-1.093.874-1.704 2.256-1.61.718.05 1.277.285 1.74.509v-.953s-.941-.235-1.827-.27z"/><path fill="#007047" d="M13.534 6.47v7.059h4.103c.97 0 1.663-.49 1.663-1.254 0-.685-.65-1.119-1.458-1.175.742-.105 1.233-.545 1.233-1.18 0-.683-.523-1.204-1.663-1.204H13.534zm3.447 1.76h.575c.2 0 .397.026.578.141.148.097.226.24.226.393 0 .154-.078.297-.226.395a.95.95 0 01-.578.141h-.575zm0 2.567h.67c.214 0 .432.03.62.138.167.096.256.236.256.393 0 .158-.09.3-.257.396-.187.107-.405.138-.62.138h-.669z"/><path fill="#BF0A30" d="M4.5 6.55v7.002h2.34l.448-.468.424.467h2.25V6.55H7.211l-.644 1.5-.699-1.5z"/><path fill="#fff" d="M8.34 7.24h.974v4.1h-.974zm-1.82 0h1.05l.524 1.252.504-1.252h.879v4.1H8.65l-.41-1.323-.511 1.323H5.92zM15.01 7.24h2.094c.615 0 1.1.251 1.1.872 0 .523-.393.847-.92.905.549.04.96.412.96.916 0 .646-.523 1.017-1.161 1.017h-2.073zm3.562 0h.987c.548 0 .87.28.87.75 0 .42-.224.716-.697.824.497.077.777.402.777.84 0 .546-.436.917-1.006.917h-.93z"/></svg>`,
      default: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><rect x="1.5" y="4" width="21" height="16" rx="3" fill="#1E1E1E" stroke="#444" stroke-width="1"></rect><rect x="4.5" y="8" width="5" height="4" rx="1" fill="#7A7A7A"></rect><rect x="4.5" y="14" width="7" height="2" fill="#333"></rect><rect x="13.5" y="14" width="7" height="2" fill="#333"></rect></svg>`
    };
    const CARD_BRAND_ALIASES = {
      amex: 'americanexpress',
      'american express': 'americanexpress',
      americanexpress: 'americanexpress',
      'american_express': 'americanexpress',
      mc: 'mastercard',
      'master card': 'mastercard',
      mastercard: 'mastercard',
      visa: 'visa',
      diners: 'dinersclub',
      'diners club': 'dinersclub',
      dinersclub: 'dinersclub',
      'diners_club': 'dinersclub',
      discover: 'discover',
      jcb: 'jcb'
    };

    function normalizeCardBrand(brand) {
      if (!brand) return 'default';
      const key = String(brand).trim().toLowerCase();
      const squashed = key.replace(/[\s_-]+/g, '');
      return CARD_BRAND_ALIASES[key] || CARD_BRAND_ALIASES[squashed] || (squashed || 'default');
    }

    function setCardBrandIcon(target, brand) {
      if (!target) return;
      const normalized = normalizeCardBrand(brand);
      const svg = CARD_BRAND_ICONS[normalized] || CARD_BRAND_ICONS.default;
      target.innerHTML = svg;
      target.classList.add('is-visible');
    }

    function formatExpirationDate(iso) {
      if (!iso) return null;
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return null;
      const formatted = d.toLocaleString('es-MX', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        hour: '2-digit',
        minute: '2-digit'
      });
      return enforceUpperMeridiem(formatted);
    }

    function showLinkExpired(expiresAtIso) {
      const summaryBox = document.querySelector('.summary-box');
      if (summaryBox) summaryBox.style.display = 'none';
      const methodLine = document.querySelector('.method-line');
      if (methodLine) methodLine.style.display = 'none';
      const buttons = document.querySelector('.two-buttons');
      if (buttons) buttons.style.display = 'none';
      const note = document.querySelector('.note');
      if (note) note.style.display = 'none';
      const spinner = document.getElementById('spinner');
      if (spinner) spinner.style.display = 'none';
      if (expiredBox) expiredBox.style.display = 'block';
      if (expiredDateEl) {
        const formatted = formatExpirationDate(expiresAtIso);
        if (formatted) {
          expiredDateEl.textContent = `Venció el ${formatted}.`;
          expiredDateEl.style.display = 'block';
        } else {
          expiredDateEl.style.display = 'none';
        }
      }
    }

    function storeSuccessPreview(snapshot) {
      try {
        sessionStorage.setItem(PREVIEW_KEY, JSON.stringify(snapshot));
      } catch (_) {}
    }

    function setPreventBackLock(orderId) {
      if (!orderId) return;
      try {
        sessionStorage.setItem(PREVENT_BACK_KEY, String(orderId));
      } catch (_) {}
    }

    function redirectToSuccess(orderId) {
      if (!orderId) return;
      setPreventBackLock(orderId);
      window.location.replace(`/success?orderId=${encodeURIComponent(orderId)}`);
    }

    function redirectIfCompleted(order) {
      if (!order || !order.id) return false;
      const status = String(order.status || '').trim().toLowerCase();
      if (!COMPLETED_STATUSES.has(status)) return false;
      redirectToSuccess(order.id);
      return true;
    }

    function buildPreviewFromOrder(order, { totalCents, vatCents, reasonText }) {
      return {
        orderId: order.id || null,
        publicCode: order.public_code || null,
        totalCents: Number(totalCents || 0),
        providerCents: toCents(order.provider_amount ?? order.pricing?.provider_amount),
        bookingCents: toCents(order.booking_fee_amount ?? order.pricing?.booking_fee_amount),
        processingCents: toCents(order.processing_fee_amount ?? order.pricing?.processing_fee_amount),
        vatCents: Number.isFinite(vatCents) ? vatCents : toCents(order.vat_amount ?? order.pricing?.vat_amount),
        kind: order.kind || '',
        reason: reasonText || String(order.adjustment_reason || ''),
        serviceAddress: order.service_address || ''
      };
    }

    (function guardCompletedOrderAccess() {
      try {
        const params = new URLSearchParams(window.location.search);
        const currentOrderId = params.get('orderId');
        const lockedOrderId = sessionStorage.getItem(PREVENT_BACK_KEY);
        if (currentOrderId && lockedOrderId && currentOrderId === lockedOrderId) {
          redirectToSuccess(currentOrderId);
        }
      } catch (guardErr) {
        console.warn('Back-navigation guard failed', guardErr);
      }
    })();

    function formatFecha(orderObj) {
      const dateOnly = orderObj.service_date || null;
      const dateTime = orderObj.service_datetime || null;
      const raw = dateTime || dateOnly;
      if (!raw) return '—';

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      const fecha = d.toLocaleDateString('es-MX', {
        weekday: 'long',
        day: '2-digit',
        month: 'long'
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);
      if (!dateTime) return cap;

      const hora = d.toLocaleTimeString('es-MX', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      return `${cap}, a las ${enforceUpperMeridiem(hora)}`;
    }

    async function syncProcessingFee(orderId, paymentIntentId, paymentMethodId) {
      if (!orderId || (!paymentIntentId && !paymentMethodId)) return;
      try {
        const payload = {};
        if (paymentIntentId) payload.paymentIntentId = paymentIntentId;
        if (paymentMethodId) payload.paymentMethodId = paymentMethodId;
        await fetch(`/orders/${encodeURIComponent(orderId)}/refresh-fees`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.warn('No se pudo actualizar la comisión real de Stripe:', err);
      }
    }

    async function initBookPage() {
      const params = new URLSearchParams(location.search);
      const orderId = params.get('orderId');
      if (!orderId) {
        alert('Falta el parámetro orderId.');
        throw new Error('missing_order_id');
      }

      const stripeResp = await fetch('/config/stripe');
      const { pk } = await stripeResp.json().catch(() => ({}));
      if (!pk) {
        alert('Stripe no está configurado.');
        throw new Error('missing_stripe_pk');
      }
      const stripe = Stripe(pk);

      const res = await fetch(`/order/${encodeURIComponent(orderId)}`);
      if (res.status === 410) {
        const payload = await res.json().catch(() => ({}));
        showLinkExpired(payload?.linkExpiresAt || payload?.link_expires_at || null);
        return;
      }
      if (!res.ok) {
        alert('Orden no encontrada.');
        throw new Error('order_not_found');
      }
      const order = await res.json();

      if (redirectIfCompleted(order)) return;

      if (!order?.saved_card) {
        location.href = `/pay?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      const isAdjustment = String(order.kind || '').toLowerCase() === 'adjustment';
      const reasonText = String(order.adjustment_reason || '').trim();

      if (isAdjustment) {
        const heading = document.querySelector('.container h2');
        const summaryTitle = document.querySelector('.summary-box h3');
        if (heading) heading.textContent = 'Confirmar ajuste';
        if (summaryTitle) summaryTitle.textContent = 'Detalles del ajuste';
      }

      const fechaTexto = formatFecha(order);
      const servicio = (order.service_description || 'servicio').trim();
      const summaryEl = $('#service-summary');
      const summaryCopy = (() => {
        if (!isAdjustment) {
          return `Reserva de ${servicio} el ${fechaTexto}.`;
        }
        const parts = [];
        if (servicio) parts.push(`Ajuste para ${servicio}`);
        if (fechaTexto && fechaTexto !== '—') parts.push(`Servicio: ${fechaTexto}`);
        return parts.length ? `${parts.join('. ')}.` : 'Ajuste pendiente de confirmación.';
      })();
      if (summaryEl) summaryEl.textContent = summaryCopy;

      const reasonRow = document.getElementById('adjustment-reason-row');
      const reasonValue = document.getElementById('adjustment-reason');
      if (isAdjustment && reasonRow) {
        reasonRow.style.display = 'flex';
        if (reasonValue) reasonValue.textContent = reasonText || 'SERVI adjustment';
      } else if (reasonRow) {
        reasonRow.style.display = 'none';
      }

      if (isAdjustment) {
        const noteCopy = document.querySelector('.note');
        if (noteCopy) {
          noteCopy.textContent = 'Se usará tu método guardado para este ajuste. Puedes cambiarlo desde el portal.';
        }
      }

      const summaryBox = document.querySelector('.summary-box');
      const totalRow = document.getElementById('total-row');
      const totalEl = document.getElementById('summary-total');
      const noteEl = document.getElementById('summary-note');

      const totalCents = toCents(order.amount ?? order.pricing?.total_amount);
      const vatCents = toCents(order.vat_amount ?? order.pricing?.vat_amount);
      const totalFormatted = formatMoneyFromCents(totalCents);

      if (totalRow && totalEl) {
        if (totalCents > 0) {
          totalEl.textContent = totalFormatted;
          totalRow.style.display = 'flex';
          if (noteEl) noteEl.style.display = vatCents > 0 ? 'block' : 'none';
        } else {
          totalRow.style.display = 'none';
          if (noteEl) noteEl.style.display = 'none';
        }
      }

      if (noteEl && summaryBox) {
        summaryBox.appendChild(noteEl);
      }

      try {
        const previewSnapshot = buildPreviewFromOrder(order, { totalCents, vatCents, reasonText });
        storeSuccessPreview(previewSnapshot);
      } catch (_) {}

      const sc = order.saved_card || {};
      const maskEl = $('#card-mask');
      if (maskEl) maskEl.textContent = `•••• ${sc.last4 || '----'}`;
      const iconEl = $('#card-brand-icon');
      if (iconEl) setCardBrandIcon(iconEl, sc.brand);
      const expEl = $('#card-expiration');
      if (expEl) {
        if (sc.exp_month && sc.exp_year) {
          const expText = `Vence ${String(sc.exp_month).padStart(2, '0')}/${String(sc.exp_year).slice(-2)}`;
          expEl.textContent = expText;
          expEl.style.display = 'block';
        } else {
          expEl.textContent = '';
          expEl.style.display = 'none';
        }
      }

      if (order.kind === 'book' && order.preauth_window_open === false) {
        const btn = document.querySelector('#btn-book');
        if (btn) {
          btn.disabled = false;
          btn.textContent = isAdjustment ? 'Confirmar ajuste' : 'Confirmar reserva';
        }
      }

      async function recordConsent() {
        const reasonPhrase = isAdjustment ? 'este ajuste' : 'mi reserva';
        const text = `Autorizo el cargo por ${totalFormatted} correspondiente a ${reasonPhrase} a mi tarjeta •••• ${sc.last4 || ''}`;
        try {
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
          const bytes = new Uint8Array(buf);
          const hash = Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
          await fetch(`/orders/${encodeURIComponent(orderId)}/consent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              version: 'v1',
              text,
              hash,
              locale: navigator.language || 'es-MX',
              tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
            })
          });
        } catch {}
      }

      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');
      const spinner = $('#spinner');
      if (!btnBook || !btnManage) return;

      if (isAdjustment) {
        btnBook.textContent = 'Confirmar ajuste';
      }

      btnBook.addEventListener('click', async () => {
        btnBook.disabled = true;
        btnManage.disabled = true;
        if (spinner) spinner.style.display = 'block';

        await recordConsent();

        const r = await fetch('/confirm-with-saved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId })
        });

        const payload = await r.json().catch(() => ({}));

        if (r.status === 200) {
          if (payload?.paymentIntentId || payload?.paymentMethodId) {
            await syncProcessingFee(orderId, payload?.paymentIntentId || null, payload?.paymentMethodId || null);
          }
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          return;
        }

        if (r.status === 409) {
          if (payload?.error === 'no_saved_card') {
            alert(payload?.message || 'Necesitamos que actualices tu método de pago para continuar.');
            const fallback = `/pay?orderId=${encodeURIComponent(orderId)}`;
            location.href = payload?.redirect || fallback;
            return;
          }
          if (payload?.paymentMethodId || payload?.paymentIntentId) {
            await syncProcessingFee(orderId, payload?.paymentIntentId || null, payload?.paymentMethodId || null);
          }
          const scheduledMsg = isAdjustment
            ? 'Tu ajuste quedó programado. Realizaremos la preautorización 12 horas antes de la fecha.'
            : 'Tu servicio quedó programado. Realizaremos la preautorización 12 horas antes de la fecha.';
          alert(payload?.message || scheduledMsg);
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          return;
        }

        if (r.status === 402 && payload?.clientSecret) {
          const result = await stripe.confirmCardPayment(payload.clientSecret);
          if (result.error) {
            alert(result.error.message || 'Error de autenticación');
            if (spinner) spinner.style.display = 'none';
            btnBook.disabled = false;
            btnManage.disabled = false;
          } else {
            const piId = result.paymentIntent?.id || null;
            const pmId = payload?.paymentMethodId || null;
            if (piId || pmId) {
              await syncProcessingFee(orderId, piId, pmId);
            }
            location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
          }
          return;
        }

        alert(payload?.error || 'No se pudo confirmar el pago.');
        if (spinner) spinner.style.display = 'none';
        btnBook.disabled = false;
        btnManage.disabled = false;
      });

      btnManage.addEventListener('click', async () => {
        btnBook.disabled = true;
        btnManage.disabled = true;

        try {
          const r = await fetch('/billing-portal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, returnUrl: location.href })
          });

          const out = await r.json().catch(() => ({}));
          if (r.ok && out?.url) {
            location.href = out.url;
            return;
          }
          alert(out?.error || out?.message || 'No se pudo abrir el portal de pago.');
        } catch {
          alert('No se pudo abrir el portal de pago.');
        } finally {
          btnBook.disabled = false;
          btnManage.disabled = false;
        }
      });
    }

    initBookPage().catch((err) => {
      console.error('Book page init failed:', err);
      if (!window.__BOOK_ALERT_SHOWN__) {
        window.__BOOK_ALERT_SHOWN__ = true;
        alert('No se pudo cargar la reserva. Actualiza la página o contacta a soporte.');
      }
    });
  </script>
</body>
</html>
