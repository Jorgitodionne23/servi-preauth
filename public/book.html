<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Purpose: 1-click “Review & Book” for saved clients using their stored card, with 3DS fallback and Billing Portal. -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservar - SERVI</title>

  <script src="https://js.stripe.com/v3/"></script>

  <!-- Same font as pay.html -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    /* === COPY of pay.html look & feel (only additions are noted) === */
    * { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 80vh;
      line-height: 1.6;
    }

    .page {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .logo {
      max-width: 150px;
      margin-bottom: 20px;
    }

    .container {
      max-width: 400px;
      width: 100%;
      background: #111;
      padding: 36px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h2 {
      text-align: center;
      margin: 0;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .summary-box {
      background-color: #1a1a1a;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: -5px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      font-size: 16px;
    }
    .summary-box h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 18px;
      color: #fff;
      font-weight: 600;
      letter-spacing: .2px;
    }
    #service-summary { margin: 0; line-height: 1.5; font-size: 15px; }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin: 6px 0;
      font-size: 14px;
      color: #9ca3af;
    }

    .summary-row span:last-child {
      color: #fff;
      font-weight: 500;
    }

    .summary-row.total {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-row.total span:first-child {
      color: #fff;
    }

    .summary-note {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }

    .method-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
      background-color: #1a1a1a;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid #222;
    }

    .two-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    button {
      background-color: #fff;
      color: #000;
      border: none;
      padding: 11px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }
    .ghost {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
    }

    .note {
      font-size: 12px;
      color: #ccc;
      margin: 0;
    }

    .support {
      font-size: 12px;
      color: #ccc;
      text-align: center;
      margin-top: 16px;
    }
    .support a { color: #fff; text-decoration: none; }

    .footer {
      margin-top: 24px;
      text-align: center;
      color: #aaa;
      padding: 24px;
    }
    .footer img {
      height: 32px;
      max-width: 100%;
      object-fit: contain;
    }

    /* Spinner (same visual language) */
    #spinner {
      display: none;
      text-align: center;
      font-size: 14px;
      color: #fff;
    }
    .spinner-circle {
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
  </style>
</head>

<body>
  <div class="page">
    <!-- Same header logo as pay.html -->
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />

    <div class="container">
      <h2>Revisa y confirma tu reserva</h2>

      <div class="summary-box">
        <h3>Detalles de tu reserva</h3>
        <p id="service-summary">Cargando…</p>
        <div class="summary-row" id="service-price-row" style="display:none;">
          <span>Precio del servicio</span>
          <span id="service-price">—</span>
        </div>
        <div class="summary-row" id="processing-fee-row" style="display:none;">
          <span>Comisión por procesamiento</span>
          <span id="processing-fee">—</span>
        </div>
        <div class="summary-row total" id="total-row" style="display:none;">
          <span>Total a pagar</span>
          <span id="summary-total">—</span>
        </div>
        <div class="summary-note" id="summary-note" style="display:none;">*IVA incluido</div>
      </div>

      <div class="method-line">
        <span>Método de pago</span>
        <strong id="card-mask">—</strong>
      </div>

      <div class="two-buttons">
        <button id="btn-book">Reservar</button>
        <button id="btn-manage" class="ghost">Administrar métodos de pago</button>
      </div>

      <p class="note">Se usará tu método guardado. Puedes cambiarlo desde el portal.</p>

      <div id="spinner">
        <div class="spinner-circle"></div>
      </div>
    </div>

    <div class="support">
      ¿Necesitas ayuda?
      <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank">Centro de ayuda</a>
      o
      <a href="https://wa.me/525525112588" target="_blank">WhatsApp</a>
    </div>
  </div>

  <div class="footer">
    <!-- Stripe lockup identical to pay.html -->
    <img src="poweredbystripe.png" alt="Powered by Stripe" />
  </div>

  <script type="module">
    // Minimal helpers
    const $ = (sel) => document.querySelector(sel);
    const mxnFormatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
    const formatMoneyFromCents = (value) => mxnFormatter.format((Number(value || 0)) / 100);
    const toCents = (value) => {
      const n = Number(value);
      return Number.isFinite(n) ? Math.round(n) : 0;
    };
    const params = new URLSearchParams(location.search);
    const orderId = params.get('orderId');

    let processingFeeRules = [];
    let defaultProcessingFeeRuleId = null;
    let vatRate = 0.16;
    let stripeFeeVatRate = 0.16;
    let baseProviderCents = 0;
    let baseBookingCents = 0;

    const summaryElements = {
      box: null,
      serviceRow: null,
      servicePrice: null,
      processingRow: null,
      processingPrice: null,
      totalRow: null,
      totalPrice: null,
      vatNote: null,
    };

    const pricingState = {
      providerAmountCents: 0,
      bookingFeeAmountCents: 0,
      processingFeeAmountCents: 0,
      vatAmountCents: 0,
      totalAmountCents: 0,
      serviceAmountCents: 0,
      ruleId: null,
      ruleLabel: '',
    };

    function normalizeCardSnapshot(card = {}) {
      return {
        brand: String(card.brand || '').toLowerCase(),
        funding: String(card.funding || '').toLowerCase(),
        country: String(card.country || '').toUpperCase(),
      };
    }

    function matchProcessingFeeRuleClient(card = {}) {
      if (!processingFeeRules.length) return null;
      const snapshot = normalizeCardSnapshot(card);
      for (const rule of processingFeeRules) {
        const match = rule.match || {};
        if (match.brand && String(match.brand).toLowerCase() !== snapshot.brand) continue;
        if (match.funding && String(match.funding).toLowerCase() !== snapshot.funding) continue;
        if (match.country) {
          const target = String(match.country).toUpperCase();
          if (target !== '*' && target !== snapshot.country) continue;
        }
        return rule;
      }
      return (
        processingFeeRules.find((rule) => rule.id === defaultProcessingFeeRuleId) ||
        processingFeeRules[0] ||
        null
      );
    }

    function computePricingPreviewClient(providerCents, bookingCents, rule) {
      if (!rule) return null;
      const baseCents = providerCents + bookingCents;
      const basePesos = baseCents / 100;
      const pEff = rule.percent * (1 + stripeFeeVatRate);
      const fEff = rule.fixed * (1 + stripeFeeVatRate);
      const denom = 1 - pEff * (1 + vatRate);
      const safeDenom = denom <= 0 ? 1 : denom;
      const processingPesos =
        basePesos <= 0 ? 0 : (pEff * (1 + vatRate) * basePesos + fEff) / safeDenom;
      const processingCents = Math.max(0, Math.round(processingPesos * 100));

      const vatBaseCents = baseCents + processingCents;
      const vatPesos = vatRate * (vatBaseCents / 100);
      const vatCents = Math.max(0, Math.round(vatPesos * 100));

      const totalCents = baseCents + processingCents + vatCents;
      const serviceAmountCents = baseCents + vatCents;

      return {
        providerAmountCents: providerCents,
        bookingFeeAmountCents: bookingCents,
        processingFeeAmountCents: processingCents,
        vatAmountCents: vatCents,
        totalAmountCents: totalCents,
        serviceAmountCents,
        ruleId: rule.id,
        ruleLabel: rule.label,
      };
    }

    function updateSummaryFromBreakdown(breakdown) {
      if (!breakdown) return;
      pricingState.providerAmountCents = breakdown.providerAmountCents ?? pricingState.providerAmountCents;
      pricingState.bookingFeeAmountCents = breakdown.bookingFeeAmountCents ?? pricingState.bookingFeeAmountCents;
      pricingState.processingFeeAmountCents =
        breakdown.processingFeeAmountCents ?? pricingState.processingFeeAmountCents;
      pricingState.vatAmountCents = breakdown.vatAmountCents ?? pricingState.vatAmountCents;
      pricingState.totalAmountCents = breakdown.totalAmountCents ?? pricingState.totalAmountCents;
      pricingState.serviceAmountCents = breakdown.serviceAmountCents ?? pricingState.serviceAmountCents;
      pricingState.ruleId = breakdown.ruleId || pricingState.ruleId;
      pricingState.ruleLabel = breakdown.ruleLabel || pricingState.ruleLabel;

      if (summaryElements.serviceRow && summaryElements.servicePrice) {
        if (pricingState.serviceAmountCents > 0) {
          summaryElements.servicePrice.textContent = formatMoneyFromCents(pricingState.serviceAmountCents);
          summaryElements.serviceRow.style.display = 'flex';
        } else {
          summaryElements.serviceRow.style.display = 'none';
        }
      }

      if (summaryElements.processingRow && summaryElements.processingPrice) {
        if (pricingState.processingFeeAmountCents > 0) {
          summaryElements.processingPrice.textContent = formatMoneyFromCents(
            pricingState.processingFeeAmountCents
          );
          summaryElements.processingRow.style.display = 'flex';
        } else {
          summaryElements.processingRow.style.display = 'none';
        }
      }

      if (summaryElements.totalRow && summaryElements.totalPrice) {
        if (pricingState.totalAmountCents > 0) {
          summaryElements.totalPrice.textContent = formatMoneyFromCents(pricingState.totalAmountCents);
          summaryElements.totalRow.style.display = 'flex';
        } else {
          summaryElements.totalRow.style.display = 'none';
        }
      }

      if (summaryElements.vatNote && summaryElements.box) {
        summaryElements.vatNote.style.display =
          pricingState.vatAmountCents > 0 ? 'block' : 'none';
        if (summaryElements.vatNote.parentElement !== summaryElements.box) {
          summaryElements.box.appendChild(summaryElements.vatNote);
        }
      }
    }

    if (!orderId) {
      alert('Falta el parámetro orderId.');
      throw new Error('Missing orderId');
    }

    // Load Stripe publishable key
    const config = await fetch('/config/stripe').then(r => r.json());
    const pk = config.pk;
    if (!pk) { alert('Stripe no está configurado.'); throw new Error('Missing Stripe key'); }
    processingFeeRules = Array.isArray(config.processingFeeRules) ? config.processingFeeRules : [];
    defaultProcessingFeeRuleId = config.defaultProcessingFeeRule || null;
    if (Number.isFinite(Number(config.vatRate))) {
      vatRate = Number(config.vatRate);
    }
    if (Number.isFinite(Number(config.stripeFeeVatRate))) {
      stripeFeeVatRate = Number(config.stripeFeeVatRate);
    }
    const stripe = Stripe(pk);

    // Get order (expects saved_card and (if needed) client_secret for 3DS)
    const res = await fetch(`/order/${encodeURIComponent(orderId)}`);
    if (!res.ok) { alert('Orden no encontrada.'); throw new Error('Order not found'); }
    const order = await res.json();

    // If no saved card, fallback to full payment form
    if (!order?.saved_card) {
      // Extra guard: if server returns 409 later, we still redirect from the click handler.
      location.href = `/pay?orderId=${encodeURIComponent(orderId)}`;
    }

    // Prefer richer display if server provides it
    const fechaTexto = formatFecha(order);
    const servicio = (order.service_description || "servicio").trim();
    $('#service-summary').textContent = `Reserva de ${servicio} el ${fechaTexto}.`;

    summaryElements.box = document.querySelector('.summary-box');
    summaryElements.serviceRow = document.getElementById('service-price-row');
    summaryElements.servicePrice = document.getElementById('service-price');
    summaryElements.processingRow = document.getElementById('processing-fee-row');
    summaryElements.processingPrice = document.getElementById('processing-fee');
    summaryElements.totalRow = document.getElementById('total-row');
    summaryElements.totalPrice = document.getElementById('summary-total');
    summaryElements.vatNote = document.getElementById('summary-note');

    baseProviderCents = toCents(order.provider_amount ?? order.pricing?.provider_amount);
    baseBookingCents = toCents(order.booking_fee_amount ?? order.pricing?.booking_fee_amount);
    const initialProcessingCents = toCents(
      order.processing_fee_amount ?? order.pricing?.processing_fee_amount
    );
    const initialVatCents = toCents(order.vat_amount ?? order.pricing?.vat_amount);
    const initialTotalCents = toCents(order.amount ?? order.pricing?.total_amount);
    const serviceWithVatCents = baseProviderCents + baseBookingCents + initialVatCents;

    updateSummaryFromBreakdown({
      providerAmountCents: baseProviderCents,
      bookingFeeAmountCents: baseBookingCents,
      processingFeeAmountCents: initialProcessingCents,
      vatAmountCents: initialVatCents,
      totalAmountCents: initialTotalCents,
      serviceAmountCents: serviceWithVatCents,
      ruleId: order.processing_fee_rule || null,
      ruleLabel: '',
    });

    if (order.processing_fee_rule && processingFeeRules.length) {
      const rule = processingFeeRules.find((r) => r.id === order.processing_fee_rule);
      if (rule) pricingState.ruleLabel = rule.label;
    }

    if (order.saved_card) {
      const dynamicRule = matchProcessingFeeRuleClient(order.saved_card);
      if (dynamicRule) {
        const preview = computePricingPreviewClient(baseProviderCents, baseBookingCents, dynamicRule);
        if (preview) {
          updateSummaryFromBreakdown(preview);
        }
      }
    }

    // Saved card mask (brand + last4 + expiry if available)
    const sc = order.saved_card || {};
    const brand = String(sc.brand || 'Tarjeta').toUpperCase();
    const exp = (sc.exp_month && sc.exp_year)
      ? ` • vence ${String(sc.exp_month).padStart(2,'0')}/${String(sc.exp_year).slice(-2)}`
      : '';
    $('#card-mask').textContent = `${brand} •••• ${sc.last4 || '----'}${exp}`;

   // If PI window not open yet (>7 days), keep button ENABLED but change copy
    if (order.kind === 'book' && order.preauth_window_open === false) {
      const btn = document.querySelector('#btn-book');
      btn.disabled = false; // keep clickable
      btn.textContent = 'Confirmar reserva';
    }



    function formatFecha(orderObj) {
      const dateOnly  = orderObj.service_date || null;
      const dateTime  = orderObj.service_datetime || null;
      const raw = dateTime || dateOnly;
      if (!raw) return "—";

      const d = new Date(raw);
      if (isNaN(d)) return String(raw);

      // Date WITHOUT year
      const fecha = d.toLocaleDateString("es-MX", {
        weekday: "long",
        day: "2-digit",
        month: "long",
      });
      const cap = fecha.charAt(0).toUpperCase() + fecha.slice(1);

      // Show time only when we actually have a timestamp (service_datetime)
      if (!dateTime) return cap;

      const hora = d.toLocaleTimeString("es-MX", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });

      return `${cap}, a las ${hora}`;
    }


    // Record consent (audit trail) — harmless if already recorded
    async function recordConsent() {
      const totalDisplay = formatMoneyFromCents(pricingState.totalAmountCents);
      const text = `Autorizo el cargo por ${totalDisplay} a mi tarjeta •••• ${sc.last4 || ''}`;
      try {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
        const bytes = new Uint8Array(buf);
        const hash  = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        await fetch(`/orders/${encodeURIComponent(orderId)}/consent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            version: 'v1', text, hash,
            locale: navigator.language || 'es-MX',
            tz: Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Mexico_City'
          })
        });
      } catch {}
    }

    // Button: Reservar (off-session with saved card; 3DS fallback)
    $('#btn-book').onclick = async () => {
      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');

      btnBook.disabled = true;
      btnManage.disabled = true;
      $('#spinner').style.display = 'block';

      await recordConsent();

      const r = await fetch('/confirm-with-saved', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orderId })
      });

      // ✅ Success (off-session authorized/captured)
      if (r.status === 200) {
        location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      if (r.status === 409) {
        const out = await r.json().catch(() => ({}));
        alert(out.message || 'Tu servicio quedó programado. Realizaremos la preautorización 12 horas antes de la fecha.');
        location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        return;
      }

      // 3DS required → confirm in browser
      const out = await r.json().catch(() => ({}));
      if (r.status === 402 && out?.clientSecret) {
        const result = await stripe.confirmCardPayment(out.clientSecret);
        if (result.error) {
          alert(result.error.message || 'Error de autenticación');
          $('#spinner').style.display = 'none';
          btnBook.disabled = false;
          btnManage.disabled = false;
        } else {
          location.href = `/success?orderId=${encodeURIComponent(orderId)}`;
        }
        return;
      }

      // Other errors
      alert(out?.error || 'No se pudo confirmar el pago.');
      $('#spinner').style.display = 'none';
      btnBook.disabled = false;
      btnManage.disabled = false;
    };


    // Button: Administrar pago (Stripe Billing Portal)
    $('#btn-manage').onclick = async () => {
      const btnBook = $('#btn-book');
      const btnManage = $('#btn-manage');
      btnBook.disabled = true;
      btnManage.disabled = true;

      try {
        const r = await fetch('/billing-portal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId, returnUrl: location.href })
        });

        const out = await r.json().catch(() => ({}));
        if (r.ok && out?.url) {
          location.href = out.url; // Stripe Billing Portal
          return;
        }
        alert(out?.error || out?.message || 'No se pudo abrir el portal de pago.');
      } catch {
        alert('No se pudo abrir el portal de pago.');
      } finally {
        btnBook.disabled = false;
        btnManage.disabled = false;
      }
    };
  </script>
</body>
</html>
