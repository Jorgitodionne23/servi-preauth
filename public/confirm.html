<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SERVI â€” ConfirmaciÃ³n adicional</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:Inter,system-ui,Arial,sans-serif;
         display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px}
    .card{max-width:520px;width:100%;background:#0f1115;border:1px solid #1f2430;border-radius:16px;padding:24px;text-align:center}
    .btn{display:inline-block;margin-top:14px;padding:10px 14px;font-weight:600;border:1px solid #232a3a;border-radius:10px;color:#fff;text-decoration:none}
    #card-wrap{display:none;margin-top:12px;text-align:left}
    #card-element{padding:12px;border-radius:10px;border:1px solid #232a3a;background:#0b0d12}
    #err{color:#f87171;margin-top:8px;min-height:1.2em}
    .muted{color:#9aa4b2;font-size:14px;margin-top:6px}
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin:0 0 8px">Confirma el ajuste</h1>
    <p id="summary" class="muted"></p>
    <p id="msg">Cargandoâ€¦</p>

    <div id="card-wrap">
      <label class="muted" for="card-element">Ingresa los datos de tu tarjeta para confirmar este ajuste:</label>
      <div id="card-element"></div>
      <div id="err"></div>
      <a class="btn" id="payBtn" href="javascript:void(0)">Pagar ajuste</a>
    </div>

    <a class="btn" id="back" href="/" style="display:none">Volver</a>
  </div>

  <script>
    // ðŸ”‘ Use your TEST key while testing; swap to pk_live_... in production
    const stripe = Stripe("pk_test_51QzK6tG7utWo2rQvhFzSBxh59IMDentv5zN7jfKWtf5vkFiGkcuEENhumOpKGjkf33tGqrL3b3o05tp0DDvcJn4r00pQcvaQXR");

    const qs = new URLSearchParams(location.search);
    const orderId = qs.get("orderId");
    const backBtn = document.getElementById('back');
    const msg = document.getElementById('msg');
    const errBox = document.getElementById('err');
    const cardWrap = document.getElementById('card-wrap');
    const payBtn = document.getElementById('payBtn');
    const summary = document.getElementById('summary');

    const elements = stripe.elements({ locale: 'es' });
    const card = elements.create('card', {
      style: {
        base: {
          fontFamily: 'Inter, system-ui, Arial, sans-serif',
          fontSize: '16px',
          color: '#fff',
          '::placeholder': { color: '#94a3b8' }
        },
        invalid: { color: '#f87171' }
      },
      hidePostalCode: true
    });
    card.mount('#card-element');

    async function loadAndConfirm() {
      try {
        // 1) Fetch order (gets client_secret)
        const r = await fetch(`/order/${encodeURIComponent(orderId)}`);
        const order = await r.json();
        if (order.error) throw new Error(order.error);

        // Show amount summary (optional)
        if (order.amount) {
          try {
            const amt = (Number(order.amount) / 100);
            summary.textContent = `Monto del ajuste: ${amt.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}`;
          } catch (_) {}
        }

        // Shortcut: already paid?
        if (order.status && /succeeded|captured|confirmed/i.test(order.status)) {
          msg.textContent = 'Listo. Tu pago adicional fue procesado.';
          backBtn.style.display = 'inline-block';
          return;
        }

        // 2) Inspect PI to decide the path
        const piResp = await stripe.retrievePaymentIntent(order.client_secret);
        const pi = piResp.paymentIntent;
        if (!pi) throw new Error('No pudimos recuperar la intenciÃ³n de pago.');

        // If PI needs customer action and ALREADY has a payment method â†’ just confirm (3DS)
        if (pi.status === 'requires_action' && pi.payment_method) {
          msg.textContent = 'Redirigiendo a tu banco para confirmarâ€¦';
          const { error, paymentIntent } = await stripe.confirmCardPayment(order.client_secret);
          if (error) return showError(error);
          return showResult(paymentIntent);
        }

        // If PI needs a payment method â†’ show Card Element and let user confirm
        if (pi.status === 'requires_payment_method' || !pi.payment_method) {
          msg.textContent = 'Ingresa tu tarjeta para confirmar este ajuste.';
          cardWrap.style.display = 'block';

          payBtn.onclick = async () => {
            payBtn.textContent = 'Procesandoâ€¦';
            payBtn.style.pointerEvents = 'none';
            errBox.textContent = '';
            const { error, paymentIntent } = await stripe.confirmCardPayment(order.client_secret, {
              payment_method: { card }
            });
            if (error) { payBtn.textContent = 'Pagar ajuste'; payBtn.style.pointerEvents = 'auto'; return showError(error); }
            return showResult(paymentIntent);
          };
          return;
        }

        // If it's already processing or succeeded
        if (pi.status === 'processing') {
          msg.textContent = 'Estamos procesando el pago. Esto puede tardar unos segundosâ€¦';
          backBtn.style.display = 'inline-block';
          return;
        }
        if (pi.status === 'succeeded' || pi.status === 'requires_capture') {
          msg.textContent = 'Â¡Listo! Ajuste confirmado.';
          backBtn.style.display = 'inline-block';
          return;
        }

        // Fallback
        msg.textContent = 'No se pudo confirmar. Intenta de nuevo o contÃ¡ctanos.';
        backBtn.style.display = 'inline-block';

      } catch (e) {
        console.error(e);
        msg.textContent = 'No encontramos tu orden.';
        backBtn.style.display = 'inline-block';
      }
    }

    function showError(error) {
      console.error('confirmCardPayment error:', error);
      errBox.textContent = error && error.message ? error.message : 'OcurriÃ³ un error al confirmar tu pago.';
      msg.textContent = 'Corrige la informaciÃ³n o intenta de nuevo.';
      backBtn.style.display = 'inline-block';
    }

    function showResult(paymentIntent) {
      const ok = paymentIntent && (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture');
      msg.textContent = ok ? 'Â¡Listo! Ajuste confirmado.' : 'Tu banco estÃ¡ procesando el pago.';
      backBtn.style.display = 'inline-block';
    }

    loadAndConfirm();
  </script>
</body>
</html>
