<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pago confirmado - SERVI</title>

  <!-- Stripe.js so we can read the PI description for adjustment reason -->
  <script src="https://js.stripe.com/v3/"></script>
  <script src="./config.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      background-color: #000;
      color: #fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 85vh;
      text-align: center;
      padding: 20px;
      line-height: 1.6;
    }

    .logo { width: 150px; margin-bottom: 10px; }

    .container {
      background-color: #111;
      padding: 30px 24px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 400px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 17px;
    }

    .checkmark-img { width: 48px; height: 48px; object-fit: contain; }

    h1 { font-size: 19px; font-weight: 600; margin: 0; line-height: 27px; letter-spacing: .5px; }

    .order-number { font-size: 14px; color: #ccc; margin-bottom: -5px; }
    .summary-box {
      background:#1a1a1a;
      width:100%;
      padding:16px;
      border-radius:10px;
      text-align:left;
    }
    .row { display:flex; justify-content:space-between; align-items:flex-start; margin:6px 0; gap:12px; }
    .label { color:#9ca3af; font-size:14px; }
    .value { color:#fff; font-size:13px; text-align:right; word-break:break-word; }
    .row.total { margin-top: 0; font-weight: 600; }
    .row.total .value { font-size: 15px; }
    .note { margin: 6px 0 10px; color: #9ca3af; font-size: 12px; }

    a.button {
      display: inline-block;
      background-color: #fff;
      color: #000;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      font-size: 15px;
    }

    .footer { font-size: 11.5px; color: #aaa; margin-top: 10px; text-align: center; }
    .footer a { color: #fff; text-decoration: none; }

    .footer-stripe { margin-top: 30px; text-align: center; }
    .footer-stripe img { height: 32px; max-width: 100%; object-fit: contain; }
  </style>
</head>
<body>
  <!-- Logo above the confirmation box -->
  <a href="https://serviservices.my.canva.site/servi" target="_blank" rel="noopener">
    <img src="logo-servi-white.png" alt="SERVI Logo" class="logo" />
  </a>

  <div class="container">
    <!-- Checkmark image -->
    <img src="checkmark-green.png" alt="Éxito" class="checkmark-img" />

    <!-- Confirmation message -->
    <h1 id="title" style="margin-bottom: 0.5em;">¡Tu servicio ha sido reservado!</h1>
    <p id="subtitle" style="margin-top: -1em; color: #ccc; font-size: 15px;">
      Te mandaremos un mensaje recordatorio antes de tu servicio.
    </p>

    <!-- Real order code from server -->
    <div class="order-number">
      Número de orden: <span id="order-id">cargando...</span>
    </div>

    <!-- Summary (amount, status, and adjustment reason when applicable) -->
    <div class="summary-box">
      <div class="row total">
        <div class="label">Total</div>
        <div class="value" id="amount">—</div>
      </div>
      <div class="note" id="vat-note" style="display:none;">*IVA incluido</div>
      <div class="row" id="service-price-row" style="display:none;">
        <div class="label" id="service-price-label">Precio del servicio</div>
        <div class="value" id="service-price">—</div>
      </div>
      <div class="row" id="processing-row" style="display:none;">
        <div class="label">Comisión por procesamiento</div>
        <div class="value" id="processing-fee">—</div>
      </div>
      <div class="row" id="email-row" style="display:none;">
        <div class="label">Correo</div>
        <div class="value" id="email-value">—</div>
      </div>
      <div class="row">
        <div class="label">Dirección</div>
        <div class="value" id="address">—</div>
      </div>
      <div class="row" id="date-row" style="display:none;">
        <div class="label">Fecha del servicio</div>
        <div class="value" id="date-value">—</div>
      </div>
      <div class="row" id="reason-row" style="display:none">
        <div class="label">Motivo del ajuste</div>
        <div class="value" id="reason">—</div>
      </div>
    </div>

    <!-- WhatsApp CTA -->
    <a href="https://wa.me/525525112588" class="button">
      Ver o modificar tu solicitud
    </a>
  </div>

  <!-- footer -->
  <div class="footer">
    ¿Necesitas ayuda?
    <a href="https://serviservices.my.canva.site/helpcenter/#reportar" target="_blank" rel="noopener">Centro de ayuda</a>
  </div>

  <div class="footer-stripe">
    <a href="https://stripe.com" target="_blank" rel="noopener">
      <img src="poweredbystripe.png" alt="Powered by Stripe" />
    </a>
  </div>

  <script>
    const CONFIG = window.CONFIG || {};
    const API_BASE = (CONFIG.API_BASE || '').replace(/\/+$/, '') || window.location.origin;
    const STRIPE_PUBLISHABLE_KEY = CONFIG.STRIPE_PUBLISHABLE_KEY || '';

    const qs = new URLSearchParams(location.search);
    let orderId = qs.get('order') || qs.get('orderId') || localStorage.getItem('orderId');
    const retryToken = qs.get('rt') || '';
    const allowExpired = qs.get('allowExpired') === '1';

    const targetOrderId = document.getElementById('order-id');
    const amountEl = document.getElementById('amount');
    const addressEl = document.getElementById('address');
    const statusEl = document.getElementById('status');
    const reasonRow = document.getElementById('reason-row');
    const reasonEl = document.getElementById('reason');
    const titleEl = document.getElementById('title');
    const subtitleEl = document.getElementById('subtitle');
    const servicePriceRow = document.getElementById('service-price-row');
    const servicePriceLabel = document.getElementById('service-price-label');
    const servicePriceEl = document.getElementById('service-price');
    const processingRow = document.getElementById('processing-row');
    const processingEl = document.getElementById('processing-fee');
    const emailRow = document.getElementById('email-row');
    const emailValueEl = document.getElementById('email-value');
    const vatNoteEl = document.getElementById('vat-note');
    const dateRow = document.getElementById('date-row');
    const dateValueEl = document.getElementById('date-value');
    const summaryBox = document.querySelector('.summary-box');

    const PREVIEW_KEY = 'serviSuccessPreview';
    const PREVIEW_CACHE_PREFIX = `${PREVIEW_KEY}:`;
    const PREVENT_BACK_KEY = 'serviPreventBack';
    const currencyCache = {};

    function fmtAmount(cents, currency = 'MXN') {
      try {
        const cur = (currency || 'MXN').toUpperCase();
        if (!currencyCache[cur]) {
          currencyCache[cur] = new Intl.NumberFormat('es-MX', { style: 'currency', currency: cur });
        }
        return currencyCache[cur].format(Number(cents || 0) / 100);
      } catch {
        return '—';
      }
    }

    function friendlyCode(order) {
      const code = order.public_code || order.publicCode || order.public_code;
      const base = code || order.id || order.orderId || '';
      return String(base).replace(/-/g, '').slice(-8).toUpperCase();
    }

    function extractReason(desc) {
      const m = (desc || '').match(/SERVI ajuste:\s*(.*)$/i);
      return m && m[1] ? m[1] : null;
    }

    function toNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : 0;
    }

    function formatServiceDateTime(rawDateTime, rawDateOnly) {
      try {
        let d = null;
        if (rawDateTime) {
          d = new Date(rawDateTime);
        } else if (rawDateOnly) {
          d = new Date(`${rawDateOnly}T12:00:00`);
        }
        if (!d || Number.isNaN(d.getTime())) return null;
        const fmt = new Intl.DateTimeFormat('es-MX', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZone: 'America/Mexico_City'
        });
        return fmt.format(d);
      } catch {
        return null;
      }
    }

    function buildPreviewFromOrder(order) {
      return {
        orderId: order.id || order.orderId || null,
        publicCode: order.public_code || order.publicCode || null,
        email: order.client_email || order.email || null,
        totalCents: toNumber(order.amount ?? order.pricing?.total_amount),
        providerCents: toNumber(order.provider_amount ?? order.pricing?.provider_amount ?? order.providerAmount),
        bookingCents: toNumber(order.booking_fee_amount ?? order.pricing?.booking_fee_amount ?? order.bookingFeeAmount),
        processingCents: toNumber(order.processing_fee_amount ?? order.pricing?.processing_fee_amount ?? order.processingFeeAmount),
        vatCents: toNumber(order.vat_amount ?? order.pricing?.vat_amount ?? order.vatAmount),
        kind: String(order.kind || ''),
        reason: String(order.adjustment_reason || order.adjustmentReason || ''),
        serviceAddress: order.service_address || order.serviceAddress || '',
        serviceDate: order.service_date || order.serviceDate || null,
        serviceDateTime: order.service_datetime || order.serviceDateTime || null,
        bookingType: order.booking_type || order.bookingType || null
      };
    }

    function storePreview(snapshot) {
      if (!snapshot) return;
      try {
        sessionStorage.setItem(PREVIEW_KEY, JSON.stringify(snapshot));
      } catch (_) {}
      try {
        if (snapshot.orderId) {
          localStorage.setItem(`${PREVIEW_CACHE_PREFIX}${snapshot.orderId}`, JSON.stringify(snapshot));
        }
      } catch (_) {}
    }

    function getPersistentPreview(orderId) {
      if (!orderId) return null;
      try {
        const raw = localStorage.getItem(`${PREVIEW_CACHE_PREFIX}${orderId}`);
        return raw ? JSON.parse(raw) : null;
      } catch (_) {
        return null;
      }
    }

    function getPreview(orderId) {
      try {
        const raw = sessionStorage.getItem(PREVIEW_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.orderId && parsed.orderId === orderId) return parsed;
        }
      } catch (_) {}
      return getPersistentPreview(orderId);
    }

    function normalizeBookingType(raw) {
      const text = String(raw || '').trim();
      if (!text) return 'rango';
      const norm = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      if (norm.includes('visita')) return 'visita';
      if (norm.includes('anticipo')) return 'anticipo';
      return 'rango';
    }

    function renderOrder(order, { totalsOverride = null, reasonOverride = null, skipStripeReason = false } = {}) {
      try {
        targetOrderId.textContent = friendlyCode(order);
      } catch (_) {
        targetOrderId.textContent = 'no disponible';
      }

      const totals = totalsOverride || {};
      const totalCents = toNumber(order.amount ?? totals.totalCents ?? order.pricing?.total_amount);
      const providerCents = toNumber(order.provider_amount ?? totals.providerCents ?? order.pricing?.provider_amount);
      const bookingCents = toNumber(order.booking_fee_amount ?? totals.bookingCents ?? order.pricing?.booking_fee_amount);
      const processingCents = toNumber(order.processing_fee_amount ?? totals.processingCents ?? order.pricing?.processing_fee_amount);
      const vatCents = toNumber(order.vat_amount ?? totals.vatCents ?? order.pricing?.vat_amount);
      const serviceCents = providerCents + bookingCents + vatCents;
      const bookingTypeKey = normalizeBookingType(order.booking_type || totals.bookingType);
      const hideBreakdownForVisit = bookingTypeKey === 'visita';
      const serviceDateDisplay = formatServiceDateTime(
        order.service_datetime ?? totals.serviceDateTime,
        order.service_date ?? totals.serviceDate
      );

      amountEl.textContent = fmtAmount(totalCents, order.currency || 'MXN');
      if (hideBreakdownForVisit) {
        servicePriceRow.style.display = 'none';
        processingRow.style.display = 'none';
      } else if (serviceCents > 0) {
        servicePriceEl.textContent = fmtAmount(serviceCents, order.currency || 'MXN');
        servicePriceRow.style.display = 'flex';
        if (servicePriceLabel) {
          const labelText =
            bookingTypeKey === 'visita'
              ? 'Costo de visita'
              : bookingTypeKey === 'anticipo'
                ? 'Monto del anticipo'
                : 'Precio del servicio';
          servicePriceLabel.textContent = labelText;
        }
      } else {
        servicePriceRow.style.display = 'none';
      }

      if (serviceDateDisplay) {
        dateValueEl.textContent = serviceDateDisplay;
        dateRow.style.display = 'flex';
      } else {
        dateRow.style.display = 'none';
      }

      if (!hideBreakdownForVisit && processingCents > 0) {
        processingEl.textContent = fmtAmount(processingCents, order.currency || 'MXN');
        processingRow.style.display = 'flex';
      } else {
        processingRow.style.display = 'none';
      }

      vatNoteEl.style.display = vatCents > 0 ? 'block' : 'none';
      if (summaryBox && vatNoteEl && servicePriceRow) {
        summaryBox.insertBefore(vatNoteEl, servicePriceRow);
      }

      addressEl.textContent = order.service_address || order.serviceAddress || totals.serviceAddress || '—';
      const emailValue = (order.client_email || order.email || totals.email || '').trim();
      if (emailValue) {
        emailValueEl.textContent = emailValue;
        emailRow.style.display = 'flex';
      } else {
        emailRow.style.display = 'none';
      }
      if (statusEl) statusEl.textContent = order.status || '—';

      const isAdjustment = String(order.kind || totals.kind || '').toLowerCase() === 'adjustment';
      if (isAdjustment) {
        titleEl.textContent = '¡Ajuste confirmado!';
        subtitleEl.textContent = 'Gracias, hemos recibido tu pago adicional.';
      } else {
        titleEl.textContent = '¡Tu servicio ha sido reservado!';
        subtitleEl.textContent = 'Te mandaremos un mensaje recordatorio antes de tu servicio.';
      }

      const fallbackReason = reasonOverride || totals.reason || '';
      let displayReason = String(order.adjustment_reason || order.adjustmentReason || '').trim() || fallbackReason;
      if (isAdjustment && displayReason) {
        reasonEl.textContent = displayReason;
        reasonRow.style.display = 'flex';
      } else {
        reasonRow.style.display = 'none';
      }

      // If adjustment and no reason yet, try Stripe metadata unless skipped
      if (isAdjustment && !displayReason && !skipStripeReason && STRIPE_PUBLISHABLE_KEY && (order.client_secret || order.clientSecret)) {
        Stripe(STRIPE_PUBLISHABLE_KEY)
          .retrievePaymentIntent(order.client_secret || order.clientSecret)
          .then((result) => {
            const reason = extractReason(result?.paymentIntent?.description);
            if (reason) {
              reasonEl.textContent = reason;
              reasonRow.style.display = 'flex';
            }
          })
          .catch(() => {});
      }
    }

    (async () => {
      if (!orderId) {
        targetOrderId.textContent = 'no disponible';
        alert('Link inválido o incompleto. Por favor contacta a soporte.');
        return;
      }

      localStorage.setItem('orderId', String(orderId));
      sessionStorage.setItem(PREVENT_BACK_KEY, String(orderId));
      const previewSnapshot = getPreview(orderId);

      try {
        const url = new URL(`${API_BASE}/order/${encodeURIComponent(orderId)}`);
        url.searchParams.set('allowExpired', '1');
        if (retryToken) url.searchParams.set('rt', retryToken);
        if (allowExpired) url.searchParams.set('allowExpired', '1');
        const res = await fetch(url.toString(), { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const order = await res.json();

        storePreview(buildPreviewFromOrder(order));
        renderOrder(order, { reasonOverride: previewSnapshot?.reason });
      } catch (err) {
        if (previewSnapshot) {
          const pseudoOrder = {
            id: previewSnapshot.orderId,
            public_code: previewSnapshot.publicCode,
            client_email: previewSnapshot.email,
            amount: previewSnapshot.totalCents,
            provider_amount: previewSnapshot.providerCents,
            booking_fee_amount: previewSnapshot.bookingCents,
            processing_fee_amount: previewSnapshot.processingCents,
            vat_amount: previewSnapshot.vatCents,
            kind: previewSnapshot.kind,
            adjustment_reason: previewSnapshot.reason,
            service_address: previewSnapshot.serviceAddress,
            service_date: previewSnapshot.serviceDate,
            service_datetime: previewSnapshot.serviceDateTime,
            status: 'Confirmed'
          };
          renderOrder(pseudoOrder, {
            totalsOverride: previewSnapshot,
            reasonOverride: previewSnapshot.reason,
            skipStripeReason: true
          });
        } else {
          targetOrderId.textContent = 'no disponible';
          amountEl.textContent = '—';
          statusEl.textContent = '—';
        }
      }
    })();
  </script>

  <script>
    // Keep users from navigating back into payment pages via the browser back button.
    (function preventBackNavigation() {
      const lockState = () => {
        window.history.pushState(null, '', window.location.href);
      };
      lockState();
      window.addEventListener('popstate', lockState);
      window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
          lockState();
        }
      });
    })();
  </script>
</body>
</html>
